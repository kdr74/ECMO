<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VA-ECMO Referral Assessment Tool v4.4</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1F4E78 0%, #2d5a8f 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #4472C4;
            color: white;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .section-header:hover {
            background: #3461b3;
        }
        
        .section-header .toggle {
            font-size: 20px;
            transition: transform 0.3s;
        }
        
        .section-header.collapsed .toggle {
            transform: rotate(-90deg);
        }
        
        .section-content {
            padding: 20px;
            background: #fafafa;
        }
        
        .section-content.hidden {
            display: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4472C4;
        }
        
        .form-group input[readonly] {
            background: #f0f0f0;
            cursor: not-allowed;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }
        
        .required {
            color: #d32f2f;
            font-weight: bold;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            border-color: #4472C4;
            background: #f8f9ff;
        }
        
        .checkbox-item.contraindication-present {
            background: #dc3545;
            border-color: #c82333;
            color: white;
        }
        
        .checkbox-item.contraindication-present label {
            color: white;
            font-weight: bold;
        }
        
        .checkbox-item .decline-label {
            margin-left: auto;
            font-weight: bold;
            color: white;
            padding: 4px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            font-size: 12px;
            display: none;
        }
        
        .checkbox-item.contraindication-present .decline-label {
            display: inline-block;
        }
        
        .checkbox-item input {
            width: auto;
            margin-right: 10px;
        }
        
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }
        
        /* SAVE Score specific styles */
        .save-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 15px;
        }
        
        .save-category {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .save-category h4 {
            color: #1F4E78;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4472C4;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .save-category .form-group {
            margin-bottom: 15px;
        }
        
        .save-category label {
            font-size: 13px;
            font-weight: 600;
        }
        
        .save-category select {
            font-size: 13px;
            padding: 8px;
        }
        
        .save-category input[readonly] {
            font-size: 13px;
            padding: 8px;
        }
        
        .result-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .result-box.success {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .result-box.danger {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .result-box.info {
            background: #d1ecf1;
            border-color: #17a2b8;
        }
        
        .result-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .result-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .results-section {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 8px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .decision-box {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .decision-box h3 {
            color: #1F4E78;
            margin-bottom: 15px;
            border-bottom: 2px solid #4472C4;
            padding-bottom: 10px;
        }
        
        .decision-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .decision-item strong {
            color: #333;
        }
        
        .final-recommendation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .calculate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            display: block;
            margin: 30px auto;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .calculate-btn:active {
            transform: translateY(0);
        }
        
        .print-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .print-btn {
            background: #4472C4;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .print-btn:hover {
            background: #3461b3;
            transform: translateY(-1px);
        }
        
        .notes-area {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        
        .notes-area:focus {
            outline: none;
            border-color: #4472C4;
        }
        
        @media (max-width: 1200px) {
            .save-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 22px;
            }
        }
        
        .info-banner {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .warning-banner {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        table th,
        table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        table th {
            background: #f5f5f5;
            font-weight: 600;
        }
        
        .score-table {
            background: white;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .calculations-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .calculations-table th,
        .calculations-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .calculations-table th {
            background: #4472C4;
            color: white;
            font-weight: 600;
        }
        
        .calculations-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .calculations-table tbody tr.calc-green {
            background: #e8f5e9;
        }
        
        .calculations-table tbody tr.calc-amber {
            background: #fff8e1;
        }
        
        .calculations-table tbody tr.calc-red {
            background: #ffebee;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
            }
            
            .calculate-btn,
            .print-buttons,
            .section-header .toggle {
                display: none;
            }
            
            .section-content {
                display: block !important;
            }
            
            .save-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>VA-ECMO Referral Assessment Tool</h1>
            <p>Version 4.0 - Evidence-Based Decision Support for Veno-Arterial ECMO Candidacy</p>
            <p style="font-size: 12px; margin-top: 10px;">Bristol ECMO Service</p>
        </div>
        
        <div class="content">
            <div class="info-banner">
                <strong>Instructions:</strong> Complete all sections sequentially. All fields marked with <span class="required">*</span> are mandatory. 
                Click "Calculate Assessment" when complete to see results and recommendation.
            </div>
            
            <!-- STEP 1: Demographics -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 1: PATIENT DEMOGRAPHICS</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Assessment Date/Time <span class="required">*</span></label>
                            <input type="datetime-local" id="assessmentDate">
                        </div>
                        <div class="form-group">
                            <label>Patient Name/ID <span class="required">*</span></label>
                            <input type="text" id="patientName" placeholder="Enter patient identifier">
                        </div>
                    </div>
                    
                    <!-- Two column layout for demographics -->
                    <div class="save-grid">
                        <!-- LEFT COLUMN: Inputs -->
                        <div>
                            <div class="form-group">
                                <label>Sex <span class="required">*</span></label>
                                <select id="sex" onchange="calculateBMIandIBW()">
                                    <option value="">Select...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Age (years) <span class="required">*</span></label>
                                <input type="number" id="age" min="18" max="100" onchange="calculateBMIandIBW()">
                            </div>
                            <div class="form-group">
                                <label>Weight (kg) <span class="required">*</span></label>
                                <input type="number" id="weight" min="30" max="250" step="0.1" onchange="calculateBMIandIBW()">
                            </div>
                            <div class="form-group">
                                <label>Height (cm) <span class="required">*</span></label>
                                <input type="number" id="height" min="100" max="250" onchange="calculateBMIandIBW()">
                            </div>
                        </div>
                        
                        <!-- RIGHT COLUMN: Auto-calculated values -->
                        <div>
                            <div class="form-group">
                                <label>BMI (kg/m²)</label>
                                <input type="text" id="bmi" readonly placeholder="Auto-calculated" style="background: #f0f0f0; font-weight: bold;">
                            </div>
                            <div class="form-group">
                                <label>Ideal Body Weight (kg)</label>
                                <input type="text" id="ibw" readonly placeholder="Auto-calculated" style="background: #f0f0f0; font-weight: bold;">
                                <div class="help-text">Uses Devine formula</div>
                            </div>
                            <div class="form-group">
                                <label>Body Surface Area (m²)</label>
                                <input type="text" id="bsa" readonly placeholder="Auto-calculated" style="background: #f0f0f0; font-weight: bold;">
                                <div class="help-text">Uses Mosteller formula</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STEP 2: Referring Centre -->
                    </div>
            
            <!-- STEP 2: Referring Centre -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 2: REFERRING CENTRE</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="save-grid">
                        <!-- LEFT COLUMN: Referring Centre Details -->
                        <div>
                            <div class="save-category">
                                <h4>Referring Centre Location</h4>
                                
                                <div class="form-group">
                                    <label>Region <span class="required">*</span></label>
                                    <select id="region" onchange="updateCounties()">
                                        <option value="">Select...</option>
                                        <option value="england">England</option>
                                        <option value="wales">Wales</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>County/Health Board <span class="required">*</span></label>
                                    <select id="county" onchange="updateHospitals()">
                                        <option value="">Select region first</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Hospital <span class="required">*</span></label>
                                    <select id="hospital" onchange="updateDistanceTime()">
                                        <option value="">Select county first</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RIGHT COLUMN: Hospital Details -->
                        <div>
                            <div class="save-category">
                                <h4>Hospital Details</h4>
                                
                                <div class="form-group">
                                    <label>Distance from BRI (km)</label>
                                    <input type="number" id="distance" readonly placeholder="Auto-filled" style="background: #f0f0f0;">
                                </div>
                                
                                <div class="form-group">
                                    <label>Est. driving time (mins)</label>
                                    <input type="number" id="drivingTime" readonly placeholder="Auto-filled" style="background: #f0f0f0;">
                                    <div class="help-text">Blue light transfer estimate</div>
                                </div>
                                
                                <div class="form-group">
                                    <label>ICU Contact Number</label>
                                    <input type="tel" id="icuContact" readonly placeholder="Auto-filled" style="background: #f0f0f0;">
                                    <div class="help-text">Auto-populated when hospital selected</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="save-category" style="margin-top: 20px;">
                        <h4>Referring Clinician Details</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Referring Clinician Name <span class="required">*</span></label>
                                <input type="text" id="referringClinicianName" placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label>Referring Clinician Grade <span class="required">*</span></label>
                                <select id="referringClinicianGrade">
                                    <option value="">Select...</option>
                                    <option value="consultant">Consultant</option>
                                    <option value="senior_registrar">Senior Registrar</option>
                                    <option value="registrar">Registrar</option>
                                    <option value="core_trainee">Core Trainee</option>
                                    <option value="foundation">Foundation</option>
                                    <option value="accp">ACCP</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Clinician Contact Number <span class="required">*</span></label>
                                <input type="tel" id="contactNumber" placeholder="Direct contact number">
                            </div>
                            <div class="form-group">
                                <label>Unit Number</label>
                                <input type="text" id="unitNumber" placeholder="Patient unit/ward number">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STEP 3: Functional Status -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 3: FUNCTIONAL STATUS</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label>Clinical Frailty Scale <span class="required">*</span></label>
                        <select id="frailty">
                            <option value="">Select...</option>
                            <option value="1">1 - Very Fit</option>
                            <option value="2">2 - Well</option>
                            <option value="3">3 - Managing Well</option>
                            <option value="4">4 - Vulnerable</option>
                            <option value="5">5 - Mildly Frail</option>
                            <option value="6">6 - Moderately Frail</option>
                            <option value="7">7 - Severely Frail</option>
                            <option value="8">8 - Very Severely Frail</option>
                            <option value="9">9 - Terminally Ill</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Performance Status (ECOG/WHO) <span class="required">*</span></label>
                        <select id="performance">
                            <option value="">Select...</option>
                            <option value="0">0 - Fully active</option>
                            <option value="1">1 - Restricted in strenuous activity</option>
                            <option value="2">2 - Ambulatory >50% waking hours</option>
                            <option value="3">3 - Capable of limited self-care</option>
                            <option value="4">4 - Completely disabled</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- STEP 4: Current Treatments -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 4: CURRENT TREATMENTS</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <!-- Respiratory Subsection -->
                    <div class="save-category">
                        <h4>Respiratory Support</h4>
                        
                        <!-- 3-column layout for Ventilation, ABG, and Calculations -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px;">
                            
                            <!-- COLUMN 1: Ventilation -->
                            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #fafafa;">
                                <h5 style="margin-top: 0; margin-bottom: 15px; color: #2c5282;">Ventilation</h5>
                                
                                <div class="form-group">
                                    <label>Ventilation Mode</label>
                                    <select id="vent_mode">
                                        <option value="">Select...</option>
                                        <option value="none">None</option>
                                        <option value="niv">Non-invasive ventilation</option>
                                        <option value="pc_simv">PC-SIMV</option>
                                        <option value="vc_simv">VC-SIMV</option>
                                        <option value="duopap">DuoPAP</option>
                                        <option value="aprv">APRV</option>
                                        <option value="tcav">TCAV</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Respiratory Rate</label>
                                    <input type="number" id="resp_rate" min="0" max="60" placeholder="breaths/min">
                                </div>
                                
                                <div class="form-group">
                                    <label>FiO₂</label>
                                    <input type="number" id="fio2_current" min="0.21" max="1" step="0.01" placeholder="0.21-1.0" oninput="updateCalculations()">
                                    <div class="help-text">Enter as fraction (e.g., 0.6 for 60%)</div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Tidal Volume (ml)</label>
                                    <input type="number" id="tidal_volume" min="0" max="2000" placeholder="ml" oninput="updateCalculations()">
                                </div>
                                
                                <div class="form-group">
                                    <label>PEEP (cmH₂O)</label>
                                    <input type="number" id="peep" min="0" max="30" placeholder="cmH₂O" oninput="updateCalculations()">
                                </div>
                                
                                <div class="form-group">
                                    <label>Peak Inspiratory Pressure (PIP, cmH₂O)</label>
                                    <input type="number" id="pip" min="0" max="60" placeholder="cmH₂O">
                                </div>
                                
                                <div class="form-group">
                                    <label>Plateau Pressure (cmH₂O)</label>
                                    <input type="number" id="plat_pressure" min="0" max="60" placeholder="cmH₂O" oninput="updateCalculations()">
                                </div>
                            </div>
                            
                            <!-- COLUMN 2: Arterial Blood Gas -->
                            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #fafafa;">
                                <h5 style="margin-top: 0; margin-bottom: 15px; color: #2c5282;">Arterial Blood Gas</h5>
                                
                                <div class="form-group">
                                    <label>pH</label>
                                    <input type="number" id="abg_ph" min="6.0" max="8.0" step="0.01" placeholder="7.35-7.45" oninput="syncBiochemicalMarkers('step4')">
                                    <div class="help-text" style="font-size: 11px; color: #2c5282;">Linked to Step 8 SCAI Classification</div>
                                </div>
                                
                                <div class="form-group">
                                    <label>PaO₂ (kPa)</label>
                                    <input type="number" id="abg_pao2" min="0" max="100" step="0.1" placeholder="kPa" oninput="updateCalculations()">
                                </div>
                                
                                <div class="form-group">
                                    <label>PaCO₂ (kPa)</label>
                                    <input type="number" id="abg_paco2" min="0" max="20" step="0.1" placeholder="kPa">
                                </div>
                                
                                <div class="form-group">
                                    <label>Lactate (mmol/L)</label>
                                    <input type="number" id="lactate" min="0" max="30" step="0.1" placeholder="mmol/L" oninput="syncBiochemicalMarkers('step4')">
                                    <div class="help-text" style="font-size: 11px; color: #2c5282;">Linked to Step 8 SCAI Classification</div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Bicarbonate (mmol/L)</label>
                                    <input type="number" id="bicarb" min="0" max="50" step="0.1" placeholder="mmol/L">
                                </div>
                                
                                <div class="form-group">
                                    <label>Base Excess</label>
                                    <input type="number" id="base_excess" min="-30" max="30" step="0.1" placeholder="mmol/L">
                                </div>
                            </div>
                            
                            <!-- COLUMN 3: Calculations -->
                            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #fafafa;">
                                <h5 style="margin-top: 0; margin-bottom: 15px; color: #2c5282;">Calculations</h5>
                                
                                <table class="calculations-table" style="width: 100%; font-size: 0.9em;">
                                    <thead>
                                        <tr>
                                            <th style="padding: 8px 5px;">Parameter</th>
                                            <th style="padding: 8px 5px;">Value</th>
                                            <th style="padding: 8px 5px;">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr id="calc_row_tv_kg">
                                            <td style="padding: 8px 5px;">Vt/kg (IBW)</td>
                                            <td id="calc_tv_kg" style="padding: 8px 5px;">-</td>
                                            <td id="calc_tv_kg_status" style="padding: 8px 5px;">-</td>
                                        </tr>
                                        <tr id="calc_row_driving_pressure">
                                            <td style="padding: 8px 5px;">Driving Pressure (ΔP)</td>
                                            <td id="calc_driving_pressure" style="padding: 8px 5px;">-</td>
                                            <td id="calc_driving_pressure_status" style="padding: 8px 5px;">-</td>
                                        </tr>
                                        <tr id="calc_row_mech_power">
                                            <td style="padding: 8px 5px;">Mechanical Power</td>
                                            <td id="calc_mech_power" style="padding: 8px 5px;">-</td>
                                            <td id="calc_mech_power_status" style="padding: 8px 5px;">-</td>
                                        </tr>
                                        <tr id="calc_row_pf_ratio">
                                            <td style="padding: 8px 5px;">P/F Ratio</td>
                                            <td id="calc_pf_ratio" style="padding: 8px 5px;">-</td>
                                            <td id="calc_pf_ratio_status" style="padding: 8px 5px;">-</td>
                                        </tr>
                                        <tr id="calc_row_ards_severity">
                                            <td style="padding: 8px 5px;">ARDS Severity (Berlin Criteria)</td>
                                            <td id="calc_ards_severity" style="padding: 8px 5px;">-</td>
                                            <td id="calc_ards_severity_status" style="padding: 8px 5px;">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Renal Support Subsection -->
                    <div class="save-category" style="margin-top: 20px;">
                        <h4>Renal Support</h4>
                        
                        <div class="form-group">
                            <label>Renal Replacement Therapy</label>
                            <select id="rrt_type">
                                <option value="">Select...</option>
                                <option value="none">None</option>
                                <option value="ihd">Intermittent haemodialysis</option>
                                <option value="cvvhdf">CVVHDF</option>
                                <option value="cvvhd">CVVHD</option>
                                <option value="scuf">SCUF</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Cardiovascular Support Subsection -->
                    <div class="save-category" style="margin-top: 20px;">
                        <h4>Cardiovascular Support</h4>
                        
                        <!-- 2-column layout for Current Support and Vasoactives -->
                        <div class="save-grid" style="margin-top: 15px;">
                            
                            <!-- COLUMN 1: Physical Examination and Current Support (linked to Step 8) -->
                            <div>
                                <div class="save-category">
                                    <h4>Physical Examination</h4>
                                    
                                    <div class="form-group">
                                        <label>Blood Pressure</label>
                                        <select id="scai_bp_step4" onchange="syncPhysicalExam('step4')">
                                            <option value="">Select...</option>
                                            <option value="normal">Normal/Mild hypotension</option>
                                            <option value="low">SBP <90 mmHg or MAP <60 mmHg</option>
                                            <option value="very_low">SBP <80 mmHg despite support</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Perfusion Status</label>
                                        <select id="scai_perfusion_step4" onchange="syncPhysicalExam('step4')">
                                            <option value="">Select...</option>
                                            <option value="normal">Warm & well perfused</option>
                                            <option value="borderline">Tachycardia but no hypoperfusion</option>
                                            <option value="impaired">Cold extremities, delayed cap refill</option>
                                            <option value="severe">Mottled, oliguria, confusion</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Volume Status</label>
                                        <select id="scai_volume_step4" onchange="syncPhysicalExam('step4')">
                                            <option value="">Select...</option>
                                            <option value="euvolemic">Euvolemic</option>
                                            <option value="mild_overload">Mild volume overload</option>
                                            <option value="pulm_edema">Pulmonary oedema</option>
                                            <option value="anasarca">Anasarca/severe overload</option>
                                        </select>
                                    </div>
                                    
                                    <div class="info-banner" style="margin-top: 15px; background: #e3f2fd;">
                                        <strong>Note:</strong> These fields are linked to Step 8 (SCAI - Physical Examination). Changes here are reflected in Step 8 and vice versa.
                                    </div>
                                </div>
                                
                                <div class="save-category" style="margin-top: 20px;">
                                    <h4>Current Support</h4>
                                    
                                    <div class="form-group">
                                        <label>Inotrope/Vasopressor Support</label>
                                        <select id="scai_support_step4" onchange="syncSupportFields('step4')">
                                            <option value="">Select...</option>
                                            <option value="none">None</option>
                                            <option value="single_low">Single agent, low dose</option>
                                            <option value="single_high">Single agent, high dose</option>
                                            <option value="multiple">Multiple agents</option>
                                            <option value="escalating">Multiple, escalating doses</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Mechanical Circulatory Support</label>
                                        <select id="scai_mcs_step4" onchange="syncSupportFields('step4')">
                                            <option value="">Select...</option>
                                            <option value="none">None</option>
                                            <option value="iabp">IABP</option>
                                            <option value="impella">Impella/other</option>
                                            <option value="multiple">Multiple devices</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Response to Initial Treatment</label>
                                        <select id="scai_response_step4" onchange="syncSupportFields('step4')">
                                            <option value="">Select...</option>
                                            <option value="na">No treatment yet / Stage A-B</option>
                                            <option value="stabilised">Stabilised with intervention</option>
                                            <option value="partial">Partial response</option>
                                            <option value="refractory">Refractory/deteriorating</option>
                                            <option value="recurrent">Recurrent CPR/pressor boluses required</option>
                                        </select>
                                        <div class="help-text">Stage D requires failure of initial intervention (≥1 hour)</div>
                                    </div>
                                    
                                    <div class="info-banner" style="margin-top: 15px; background: #e3f2fd;">
                                        <strong>Note:</strong> These fields are linked to Step 8 (SCAI - Current Support). Changes here are reflected in Step 8 and vice versa.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- COLUMN 2: Vasoactives -->
                            <div>
                                <div class="save-category">
                                    <h4>Vasoactives</h4>
                                    
                                    <div class="form-group">
                                        <label>Noradrenaline (mcg/kg/min)</label>
                                        <input type="text" id="dose_noradrenaline" placeholder="mcg/kg/min">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Vasopressin (units/min)</label>
                                        <input type="text" id="dose_vasopressin" placeholder="units/min">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Dobutamine (mcg/kg/min)</label>
                                        <input type="text" id="dose_dobutamine" placeholder="mcg/kg/min">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Milrinone (mcg/kg/min)</label>
                                        <input type="text" id="dose_milrinone" placeholder="mcg/kg/min">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Enoximone (mcg/kg/min)</label>
                                        <input type="text" id="dose_enoximone" placeholder="mcg/kg/min">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Levosimendan (mcg/kg/min)</label>
                                        <input type="text" id="dose_levo" placeholder="mcg/kg/min">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Adrenaline (mcg/kg/min)</label>
                                        <input type="text" id="dose_adrenaline" placeholder="mcg/kg/min">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Steroids (Shock dose)</label>
                                        <select id="steroids_shock">
                                            <option value="">Select...</option>
                                            <option value="no">No</option>
                                            <option value="yes">Yes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STEP 5: Absolute Contraindications -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 5: ABSOLUTE CONTRAINDICATIONS SCREENING</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="warning-banner">
                        <strong>Critical:</strong> If ANY contraindication is present, assessment will automatically recommend DECLINE.
                    </div>
                    
                    <div class="save-grid">
                        <div class="checkbox-group">
                            <div class="checkbox-item" id="contra1_box">
                                <input type="checkbox" id="contra1" onchange="updateContraindication('contra1')">
                                <label for="contra1">Unwitnessed cardiac arrest</label>
                                <span class="decline-label">DECLINE</span>
                            </div>
                            <div class="checkbox-item" id="contra2_box">
                                <input type="checkbox" id="contra2" onchange="updateContraindication('contra2')">
                                <label for="contra2">Prolonged CPR >60 minutes without ROSC</label>
                                <span class="decline-label">DECLINE</span>
                            </div>
                            <div class="checkbox-item" id="contra3_box">
                                <input type="checkbox" id="contra3" onchange="updateContraindication('contra3')">
                                <label for="contra3">Severe irreversible brain injury</label>
                                <span class="decline-label">DECLINE</span>
                            </div>
                            <div class="checkbox-item" id="contra4_box">
                                <input type="checkbox" id="contra4" onchange="updateContraindication('contra4')">
                                <label for="contra4">Uncontrolled bleeding/coagulopathy</label>
                                <span class="decline-label">DECLINE</span>
                            </div>
                            <div class="checkbox-item" id="contra5_box">
                                <input type="checkbox" id="contra5" onchange="updateContraindication('contra5')">
                                <label for="contra5">Do Not Resuscitate (DNR) order</label>
                                <span class="decline-label">DECLINE</span>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <div class="checkbox-item" id="contra6_box">
                                <input type="checkbox" id="contra6" onchange="updateContraindication('contra6')">
                                <label for="contra6">Terminal malignancy (life expectancy <1 year)</label>
                                <span class="decline-label">DECLINE</span>
                            </div>
                            <div class="checkbox-item" id="contra7_box">
                                <input type="checkbox" id="contra7" onchange="updateContraindication('contra7')">
                                <label for="contra7">Severe multi-organ failure pre-arrest</label>
                                <span class="decline-label">DECLINE</span>
                            </div>
                            <div class="checkbox-item" id="contra8_box">
                                <input type="checkbox" id="contra8" onchange="updateContraindication('contra8')">
                                <label for="contra8">Advanced dementia or severe neurological disability</label>
                                <span class="decline-label">DECLINE</span>
                            </div>
                            <div class="checkbox-item" id="contra9_box">
                                <input type="checkbox" id="contra9" onchange="updateContraindication('contra9')">
                                <label for="contra9">Patient/family refusal of escalation</label>
                                <span class="decline-label">DECLINE</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STEP 6: Investigations -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 6: INVESTIGATIONS</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="info-banner">
                        <strong>Haematology:</strong> Enter most recent values
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Haemoglobin (Hb, g/L)</label>
                            <input type="number" id="haemoglobin" min="0" max="300" placeholder="g/L">
                        </div>
                        <div class="form-group">
                            <label>Platelets (×10⁹/L)</label>
                            <input type="number" id="platelets" min="0" max="1000" step="1" placeholder="×10⁹/L">
                        </div>
                    </div>
                    
                    <div class="info-banner" style="margin-top: 20px;">
                        <strong>Biochemistry:</strong> Enter most recent values
                    </div>
                    
                    <div class="form-row-3">
                        <div class="form-group">
                            <label>Creatinine (µmol/L)</label>
                            <input type="number" id="creatinine" min="0" max="2000" placeholder="µmol/L" oninput="calculateEGFR()">
                        </div>
                        <div class="form-group">
                            <label>Bilirubin (µmol/L)</label>
                            <input type="number" id="bilirubin" min="0" max="1000" placeholder="µmol/L">
                        </div>
                        <div class="form-group">
                            <label>ALT (U/L)</label>
                            <input type="number" id="alt" min="0" max="10000" placeholder="U/L">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>eGFR (ml/min/1.73m²)</label>
                            <input type="number" id="egfr" readonly placeholder="Auto-calculated" style="background: #f0f0f0;">
                            <div class="help-text">Calculated from age, sex, and creatinine</div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- STEP 7: Echocardiogram -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 7: ECHOCARDIOGRAM</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type</label>
                            <select id="echo_type">
                                <option value="">Select...</option>
                                <option value="none">None</option>
                                <option value="tte">TTE</option>
                                <option value="toe">TOE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Pericardial Effusion</label>
                            <select id="pericardial_effusion">
                                <option value="">Select...</option>
                                <option value="none">None</option>
                                <option value="no_tamponade">Yes - No tamponade</option>
                                <option value="tamponade">Yes - Tamponade</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="info-banner" style="margin-top: 20px;">
                        <strong>Function</strong>
                    </div>
                    
                    <div class="save-grid">
                        <!-- LEFT COLUMN: Left Heart -->
                        <div>
                            <div class="save-category">
                                <h4>Left Heart</h4>
                                
                                <div class="form-group">
                                    <label>LV Systolic Function</label>
                                    <select id="lvef">
                                        <option value="">Select...</option>
                                        <option value="unknown">Unknown</option>
                                        <option value=">55%">>55% (Normal)</option>
                                        <option value="45-54%">45-54% (Mild LV impairment)</option>
                                        <option value="30-44%">30-44% (Moderate LV impairment)</option>
                                        <option value="<30%"><30% (Severe LV impairment)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label>LVEF Measured Value (%)</label>
                                    <input type="number" id="lvef_measured" min="0" max="100" placeholder="Actual measured %">
                                </div>
                                
                                <div class="info-banner" style="margin-top: 20px;">
                                    <strong>Left-sided Valves</strong>
                                </div>
                                
                                <table class="calculations-table" style="margin-top: 15px;">
                                    <thead>
                                        <tr>
                                            <th style="width: 33%;">Pathology</th>
                                            <th style="width: 33%;">Mitral</th>
                                            <th style="width: 34%;">Aortic</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Stenosis</strong></td>
                                            <td>
                                                <select id="mitral_stenosis_severity" style="width: 100%; padding: 5px;">
                                                    <option value="">Select...</option>
                                                    <option value="none">None</option>
                                                    <option value="mild">Mild</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="severe">Severe</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select id="aortic_stenosis_severity" style="width: 100%; padding: 5px;">
                                                    <option value="">Select...</option>
                                                    <option value="none">None</option>
                                                    <option value="mild">Mild</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="severe">Severe</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Regurgitation</strong></td>
                                            <td>
                                                <select id="mitral_regurgitation_severity" style="width: 100%; padding: 5px;">
                                                    <option value="">Select...</option>
                                                    <option value="none">None</option>
                                                    <option value="mild">Mild</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="severe">Severe</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select id="aortic_regurgitation_severity" style="width: 100%; padding: 5px;">
                                                    <option value="">Select...</option>
                                                    <option value="none">None</option>
                                                    <option value="mild">Mild</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="severe">Severe</option>
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- RIGHT COLUMN: Right Heart -->
                        <div>
                            <div class="save-category">
                                <h4>Right Heart</h4>
                                
                                <div class="form-group">
                                    <label>RV Systolic Function</label>
                                    <select id="rvef">
                                        <option value="">Select...</option>
                                        <option value="unknown">Unknown</option>
                                        <option value="normal">Normal RV (no dilation, TAPSE>17)</option>
                                        <option value="mild">Mild RV impairment (mildly dilated, TAPSE 14-17)</option>
                                        <option value="moderate">Moderate RV impairment (moderately dilated, TAPSE 10-14)</option>
                                        <option value="severe">Severe RV impairment (severely dilated, TAPSE <10)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label>PA Pressure Measurement (mmHg)</label>
                                    <input type="number" id="pa_pressure" placeholder="mmHg">
                                </div>
                                
                                <div class="info-banner" style="margin-top: 20px;">
                                    <strong>Right-sided Valves</strong>
                                </div>
                                
                                <table class="calculations-table" style="margin-top: 15px;">
                                    <thead>
                                        <tr>
                                            <th style="width: 33%;">Pathology</th>
                                            <th style="width: 33%;">Tricuspid</th>
                                            <th style="width: 34%;">Pulmonary</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Stenosis</strong></td>
                                            <td>
                                                <select id="tricuspid_stenosis_severity" style="width: 100%; padding: 5px;">
                                                    <option value="">Select...</option>
                                                    <option value="none">None</option>
                                                    <option value="mild">Mild</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="severe">Severe</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select id="pulmonary_stenosis_severity" style="width: 100%; padding: 5px;">
                                                    <option value="">Select...</option>
                                                    <option value="none">None</option>
                                                    <option value="mild">Mild</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="severe">Severe</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Regurgitation</strong></td>
                                            <td>
                                                <select id="tricuspid_regurgitation_severity" style="width: 100%; padding: 5px;">
                                                    <option value="">Select...</option>
                                                    <option value="none">None</option>
                                                    <option value="mild">Mild</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="severe">Severe</option>
                                                </select>
                                            </td>
                                            <td>
                                                <select id="pulmonary_regurgitation_severity" style="width: 100%; padding: 5px;">
                                                    <option value="">Select...</option>
                                                    <option value="none">None</option>
                                                    <option value="mild">Mild</option>
                                                    <option value="moderate">Moderate</option>
                                                    <option value="severe">Severe</option>
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STEP 8: SCAI Classification -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 8: SCAI SHOCK CLASSIFICATION & ASSESSMENT</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="info-banner">
                        <strong>SCAI Staging Guide:</strong> Use physical examination, biochemical markers, and hemodynamics to classify shock severity. 
                        Consider all three domains when assigning stage.
                    </div>
                    
                    <!-- Two column layout for SCAI assessment -->
                    <div class="save-grid">
                        <!-- LEFT COLUMN: Clinical Assessment -->
                        <div>
                            <div class="save-category">
                                <h4>Physical Examination</h4>
                                
                                <div class="form-group">
                                    <label>Blood Pressure</label>
                                    <select id="scai_bp" onchange="autoCalculateSCAI(); syncPhysicalExam('step8');">
                                        <option value="">Select...</option>
                                        <option value="normal">Normal/Mild hypotension</option>
                                        <option value="low">SBP <90 mmHg or MAP <60 mmHg</option>
                                        <option value="very_low">SBP <80 mmHg despite support</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Perfusion Status</label>
                                    <select id="scai_perfusion" onchange="autoCalculateSCAI(); syncPhysicalExam('step8');">
                                        <option value="">Select...</option>
                                        <option value="normal">Warm & well perfused</option>
                                        <option value="borderline">Tachycardia but no hypoperfusion</option>
                                        <option value="impaired">Cold extremities, delayed cap refill</option>
                                        <option value="severe">Mottled, oliguria, confusion</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Volume Status</label>
                                    <select id="scai_volume" onchange="syncPhysicalExam('step8');">
                                        <option value="">Select...</option>
                                        <option value="euvolemic">Euvolemic</option>
                                        <option value="mild_overload">Mild volume overload</option>
                                        <option value="pulm_edema">Pulmonary oedema</option>
                                        <option value="anasarca">Anasarca/severe overload</option>
                                    </select>
                                </div>
                                
                                <div class="info-banner" style="margin-top: 15px; background: #e3f2fd;">
                                    <strong>Note:</strong> These fields are linked to Step 4 (Cardiovascular Support - Physical Examination). Changes here are reflected in Step 4 and vice versa.
                                </div>
                            </div>
                            
                            <div class="save-category">
                                <h4>Biochemical Markers</h4>
                                
                                <div class="form-group">
                                    <label>Lactate (mmol/L)</label>
                                    <input type="number" id="scai_lactate" onchange="autoCalculateSCAI(); syncBiochemicalMarkers('step8');" oninput="autoCalculateSCAI(); syncBiochemicalMarkers('step8');" step="0.1" min="0" placeholder="Enter value">
                                    <div class="help-text">Stage C:≥2, Stage D:>2 and rising, Stage E:>5 | Linked to Step 4 ABG</div>
                                </div>
                                
                                <div class="form-group">
                                    <label>pH (Arterial)</label>
                                    <input type="number" id="scai_ph" onchange="autoCalculateSCAI(); syncBiochemicalMarkers('step8');" oninput="autoCalculateSCAI(); syncBiochemicalMarkers('step8');" step="0.01" min="6.5" max="7.8" placeholder="Enter value">
                                    <div class="help-text">Stage E: pH <7.2 | Linked to Step 4 ABG</div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Creatinine/Renal Function</label>
                                    <select id="scai_renal" onchange="autoCalculateSCAI()">
                                        <option value="">Select...</option>
                                        <option value="normal">Normal</option>
                                        <option value="mild">Mild elevation</option>
                                        <option value="moderate">Moderate impairment</option>
                                        <option value="severe">Severe AKI/anuria</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Liver Function</label>
                                    <select id="scai_liver" onchange="autoCalculateSCAI()">
                                        <option value="">Select...</option>
                                        <option value="normal">Normal</option>
                                        <option value="mild">Mildly elevated transaminases</option>
                                        <option value="moderate">Moderately elevated</option>
                                        <option value="severe">Shock liver (ALT >500)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RIGHT COLUMN: Support & Stage -->
                        <div>
                            <div class="save-category">
                                <h4>Current Support</h4>
                                
                                <div class="form-group">
                                    <label>Inotrope/Vasopressor Support</label>
                                    <select id="scai_support" onchange="autoCalculateSCAI(); syncSupportFields('step8');">
                                        <option value="">Select...</option>
                                        <option value="none">None</option>
                                        <option value="single_low">Single agent, low dose</option>
                                        <option value="single_high">Single agent, high dose</option>
                                        <option value="multiple">Multiple agents</option>
                                        <option value="escalating">Multiple, escalating doses</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Mechanical Circulatory Support</label>
                                    <select id="scai_mcs" onchange="syncSupportFields('step8');">
                                        <option value="">Select...</option>
                                        <option value="none">None</option>
                                        <option value="iabp">IABP</option>
                                        <option value="impella">Impella/other</option>
                                        <option value="multiple">Multiple devices</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Response to Initial Treatment</label>
                                    <select id="scai_response" onchange="autoCalculateSCAI(); syncSupportFields('step8');">
                                        <option value="">Select...</option>
                                        <option value="na">No treatment yet / Stage A-B</option>
                                        <option value="stabilised">Stabilised with intervention</option>
                                        <option value="partial">Partial response</option>
                                        <option value="refractory">Refractory/deteriorating</option>
                                        <option value="recurrent">Recurrent CPR/pressor boluses required</option>
                                    </select>
                                    <div class="help-text">Stage D requires failure of initial intervention (≥1 hour)</div>
                                </div>
                                
                                <div class="info-banner" style="margin-top: 15px; background: #e3f2fd;">
                                    <strong>Note:</strong> These fields are linked to Step 4 (Cardiovascular Support). Changes here are reflected in Step 4 and vice versa.
                                </div>
                            </div>
                            
                            <div class="save-category">
                                <h4>SCAI Stage Classification</h4>
                                
                                <div class="form-group">
                                    <label>Auto-Calculated SCAI Stage</label>
                                    <input type="text" id="scai_auto" readonly placeholder="Complete assessment for auto-calculation" style="background: #fff3cd; font-weight: bold; font-size: 16px;">
                                    <div class="help-text">Based on clinical criteria entered above</div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Cardiac Arrest Present?</label>
                                    <select id="cardiac_arrest" onchange="autoCalculateSCAI()">
                                        <option value="">Select...</option>
                                        <option value="no">No</option>
                                        <option value="yes">Yes</option>
                                    </select>
                                    <div class="help-text">Affects mortality prediction</div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Predicted In-Hospital Mortality</label>
                                    <input type="text" id="scai_mortality" readonly placeholder="Select cardiac arrest status" style="background: #f8d7da; font-weight: bold; font-size: 16px;">
                                </div>
                                
                                <div class="form-group">
                                    <label>Manual Override (if needed)</label>
                                    <select id="scai">
                                        <option value="">Use auto-calculated</option>
                                        <option value="A">Override: Stage A - At Risk</option>
                                        <option value="B">Override: Stage B - Beginning Shock</option>
                                        <option value="C">Override: Stage C - Classic Shock</option>
                                        <option value="D">Override: Stage D - Deteriorating</option>
                                        <option value="E">Override: Stage E - Extremis</option>
                                    </select>
                                    <div class="help-text">Only use if clinical judgement differs from auto-calculation</div>
                                </div>
                                
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 15px;">
                                    <strong>Stage Definitions & Mortality:</strong>
                                    <table style="width: 100%; font-size: 12px; margin-top: 10px;">
                                        <thead>
                                            <tr style="background: #e0e0e0;">
                                                <th style="padding: 8px; border: 1px solid #ccc;">Stage</th>
                                                <th style="padding: 8px; border: 1px solid #ccc;">Definition</th>
                                                <th style="padding: 8px; border: 1px solid #ccc;">Mortality (No CA)</th>
                                                <th style="padding: 8px; border: 1px solid #ccc;">Mortality (With CA)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ccc;"><strong>A</strong></td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">At risk (normal perfusion)</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">-</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">-</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ccc;"><strong>B</strong></td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">Hypotension/tachycardia, no hypoperfusion</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">5%</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">26%</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ccc;"><strong>C</strong></td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">Hypoperfusion (lactate ≥2, pressors/MCS)</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">8%</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">40%</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ccc;"><strong>D</strong></td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">Deteriorating (rising lactate, escalating support)</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">32%</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">54%</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ccc;"><strong>E</strong></td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">Extremis (pH<7.2, lactate>5, recurrent CPR)</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">55%</td>
                                                <td style="padding: 8px; border: 1px solid #ccc;">77%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="warning-banner" style="margin-top: 20px;">
                        <strong>ECMO Suitability Consideration:</strong> SCAI Stages D & E typically indicate higher ECMO candidacy if no contraindications. 
                        Stages A-C may require optimisation before considering ECMO. Combined with SAVE score for final decision.
                    </div>
                </div>
            </div>
            
            
            <!-- STEP 8A: SCAI-E Aetiology Score -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 8A: SCAI-E AETIOLOGY SCORE (For Stage E Patients)</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="info-banner">
                        <strong>For SCAI Stage E patients only.</strong> Select the primary aetiology. 
                        Only the highest risk category applies (min score 1, max score 3).
                    </div>
                    
                    <div class="form-group">
                        <label>Primary Aetiology <span class="required">*</span></label>
                        <select id="scai_e_aetiology" onchange="calculateSCAIE()">
                            <option value="">Select...</option>
                            <optgroup label="FAVOURABLE RISK (Score: 1)">
                                <option value="1">Fulminant myocarditis</option>
                                <option value="1">Pulmonary embolism (PE)</option>
                                <option value="1">Drug overdose</option>
                                <option value="1">First presentation cardiomyopathy</option>
                                <option value="1">Transplant primary graft dysfunction (PGD)</option>
                                <option value="1">Reversible valvular conditions</option>
                                <option value="1">Septic cardiomyopathy</option>
                            </optgroup>
                            <optgroup label="HIGH RISK (Score: 2)">
                                <option value="2">MI with full/early revascularisation</option>
                                <option value="2">Acute mitral regurgitation</option>
                                <option value="2">Acute rejection of heart transplant</option>
                            </optgroup>
                            <optgroup label="UNFAVOURABLE RISK (Score: 3)">
                                <option value="3">MI with delayed/failed revascularisation</option>
                                <option value="3">Ischaemic VSD post acute MI</option>
                                <option value="3">Post-cardiotomy</option>
                                <option value="3">Chronic rejection of heart transplant</option>
                                <option value="3">Chronic cardiomyopathy without VAD / transplant candidacy</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="result-box info" style="margin-top: 15px;">
                        <div class="result-label">SCAI-E Aetiology Score</div>
                        <div class="result-value" id="aetiology_score_display">Not calculated</div>
                    </div>
                </div>
            </div>
            
            <!-- STEP 8B: SCAI-E Onset Score -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 8B: SCAI-E ONSET SCORE (Duration Before ECMO)</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="info-banner">
                        <strong>For SCAI Stage E patients only.</strong> Time from onset of Stage E shock to ECMO consideration.
                    </div>
                    
                    <div class="form-group">
                        <label>Duration of Stage E Shock Before ECMO <span class="required">*</span></label>
                        <select id="scai_e_onset" onchange="calculateSCAIE()">
                            <option value="">Select...</option>
                            <option value="0"><6 hours (Score: 0)</option>
                            <option value="1">6-12 hours (Score: 1)</option>
                            <option value="2">>12 hours (Score: 2)</option>
                        </select>
                        <div class="help-text">Earlier intervention generally associated with better outcomes</div>
                    </div>
                    
                    <div class="result-box info" style="margin-top: 15px;">
                        <div class="result-label">SCAI-E Onset Score</div>
                        <div class="result-value" id="onset_score_display">Not calculated</div>
                    </div>
                </div>
            </div>
            
            <!-- STEP 8C: SCAI-E Comorbidity Score -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 8C: SCAI-E SIGNIFICANT COMORBIDITY SCORE</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="info-banner">
                        <strong>Significant comorbidities.</strong> Presence of ANY of these conditions scores 1. 
                        Maximum score is 1 even if multiple present.
                    </div>
                    
                    <div class="save-grid">
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="comorbid1" onchange="calculateSCAIE()">
                                <label for="comorbid1">Peripheral vascular disease</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="comorbid2" onchange="calculateSCAIE()">
                                <label for="comorbid2">Previous IHD/revascularisation</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="comorbid3" onchange="calculateSCAIE()">
                                <label for="comorbid3">Prior cardiac surgery</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="comorbid4" onchange="calculateSCAIE()">
                                <label for="comorbid4">Moderate COPD (FEV₁ 50-80%)</label>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="comorbid5" onchange="calculateSCAIE()">
                                <label for="comorbid5">Chronic renal failure (eGFR 15-60)</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="comorbid6" onchange="calculateSCAIE()">
                                <label for="comorbid6">Chronic liver disease</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="comorbid7" onchange="calculateSCAIE()">
                                <label for="comorbid7">Long-term immunosuppression</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-box info" style="margin-top: 15px;">
                        <div class="result-label">SCAI-E Comorbidity Score</div>
                        <div class="result-value" id="comorbidity_score_display">Not calculated</div>
                    </div>
                </div>
            </div>
            
            <!-- SCAI-E Total Score Summary -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>SCAI-E TOTAL SCORE SUMMARY</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="warning-banner">
                        <strong>SCAI-E Combined Risk Score:</strong> Sum of Aetiology + Onset + Comorbidity scores. 
                        Range: 1-6 points. Higher scores indicate higher risk.
                    </div>
                    
                    <div class="results-grid" style="margin-top: 20px;">
                        <div class="result-box">
                            <div class="result-label">Aetiology Score</div>
                            <div class="result-value" id="aetiology_component">-</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Onset Score</div>
                            <div class="result-value" id="onset_component">-</div>
                        </div>
                        <div class="result-box">
                            <div class="result-label">Comorbidity Score</div>
                            <div class="result-value" id="comorbidity_component">-</div>
                        </div>
                        <div class="result-box info">
                            <div class="result-label">SCAI-E TOTAL</div>
                            <div class="result-value" id="scai_e_total">-</div>
                        </div>
                    </div>
                    
                    <div id="scai_e_risk_display" style="margin-top: 20px;">
                        <div class="warning-banner">
                            <strong>Complete patient age and SCAI-E scores to see age-adjusted risk category</strong>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="color: #1F4E78; margin-bottom: 15px;">Age-Dependent Risk Stratification</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Age Group</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Score 1-2</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Score 3</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Score 4</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Score 5-6</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">&lt;40 years</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #28a745; color: white; text-align: center;"><strong>Highly Favourable</strong></td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #28a745; color: white; text-align: center;"><strong>Highly Favourable</strong></td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #ffc107; color: white; text-align: center;"><strong>Intermediate Risk</strong></td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #dc3545; color: white; text-align: center;"><strong>High Risk</strong></td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">40-64 years</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #28a745; color: white; text-align: center;"><strong>Highly Favourable</strong></td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #ffc107; color: white; text-align: center;"><strong>Intermediate Risk</strong></td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #dc3545; color: white; text-align: center;"><strong>High Risk</strong></td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #001f3f; color: white; text-align: center;"><strong>Inappropriate</strong></td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">≥65 years</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #ffc107; color: white; text-align: center;"><strong>Intermediate Risk</strong></td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #dc3545; color: white; text-align: center;"><strong>High Risk</strong></td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #001f3f; color: white; text-align: center;"><strong>Inappropriate</strong></td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #001f3f; color: white; text-align: center;"><strong>Inappropriate</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="help-text" style="margin-top: 10px;">
                            Risk categories guide ECMO candidacy in conjunction with SAVE score and clinical context.
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 9: CardShock Score -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 9: CARDSHOCK RISK SCORE</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="info-banner">
                        <strong>Complete CardShock Assessment:</strong> Age and lactate variables auto-populate from patient data. 
                        Select Yes/No for each parameter. Scores create 5 groups: 0-3 Low Risk, 4-5 Intermediate, 6-7 High, 8 High with 77% mortality, ≥9 High Risk with autopop from creatinine/age/weight/BSA.
                    </div>
                    
                    <table class="score-table">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th style="width: 100px;">Points</th>
                                <th style="width: 150px;">Present?</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Age >76 years</td>
                                <td>+1</td>
                                <td>
                                    <select id="cardshock_age">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (+1)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                    <div class="help-text">Auto-populated from patient age</div>
                                </td>
                            </tr>
                            <tr>
                                <td>Confusion at admission</td>
                                <td>+3</td>
                                <td>
                                    <select id="cardshock_confusion">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (+3)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>Previous ACS (Acute Coronary Syndrome)</td>
                                <td>+2</td>
                                <td>
                                    <select id="cardshock_previous_acs">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (+2)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <td>LVEF <40%</td>
                                <td>+1</td>
                                <td>
                                    <select id="cardshock_lvef">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (+1)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                    <div class="help-text">From echocardiogram data</div>
                                </td>
                            </tr>
                            <tr>
                                <td>Lactate >2 mmol/L</td>
                                <td>+2</td>
                                <td>
                                    <select id="cardshock_lactate">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (+2)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                    <div class="help-text">Auto-populated from lactate measurement</div>
                                </td>
                            </tr>
                            <tr>
                                <td>Lactate >4 mmol/L</td>
                                <td>+2</td>
                                <td>
                                    <select id="cardshock_lactate_high">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (+2)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                    <div class="help-text">Additional points if >4</div>
                                </td>
                            </tr>
                            <tr>
                                <td>eGFR <30 mL/min/1.73m²</td>
                                <td>+2</td>
                                <td>
                                    <select id="cardshock_egfr">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (+2)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                    <div class="help-text">Calculate from creatinine/age/weight/BSA</div>
                                </td>
                            </tr>
                            <tr>
                                <td>Unknown variable</td>
                                <td>0</td>
                                <td>
                                    <select id="cardshock_unknown">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (0)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
                        <h4 style="color: #1F4E78; margin-bottom: 15px;">CardShock Risk Groups</h4>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Score</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Risk Group</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Mortality</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">0-3</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #d4edda;">Low Risk</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">Lowest mortality</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">4-5</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #fff3cd;">Intermediate Risk</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">Moderate mortality</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">6-7</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #f8d7da;">High Risk</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">High mortality</td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">8</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #f8d7da;">High Risk</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>77% predicted mortality</strong></td>
                                </tr>
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">≥9</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; background: #721c24; color: white;">Very High Risk</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>>77% predicted mortality</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- STEP 10: SAVE Score -->
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <span>STEP 10: SAVE SCORE (Survival After VA-ECMO)</span>
                    <span class="toggle">−</span>
                </div>
                <div class="section-content">
                    <div class="warning-banner">
                        <strong>All parameters mandatory:</strong> SAVE score cannot be calculated with missing data. 
                        Complete every field to obtain valid survival prediction.
                    </div>
                    
                    <div class="save-grid">
                        <!-- LEFT COLUMN -->
                        <div>
                            <!-- Demographics & Diagnosis -->
                            <div class="save-category">
                                <h4>Demographics & Diagnosis</h4>
                                
                                <div class="form-group">
                                    <label>Age Category <span class="required">*</span></label>
                                    <input type="text" id="save_age_display" readonly placeholder="Enter age in Step 1">
                                </div>
                                
                                <div class="form-group">
                                    <label>Weight Category <span class="required">*</span></label>
                                    <input type="text" id="save_weight_display" readonly placeholder="Enter weight in Step 1">
                                </div>
                                
                                <div class="form-group">
                                    <label>Diagnosis Group <span class="required">*</span></label>
                                    <select id="save_diagnosis">
                                        <option value="">Select...</option>
                                        <option value="myocarditis">Myocarditis (+3)</option>
                                        <option value="vtfvf">Refractory VT/VF (+2)</option>
                                        <option value="transplant">Post heart/lung transplantation (+3)</option>
                                        <option value="chd">Congenital heart disease (-3)</option>
                                        <option value="cardiotomy">Post-cardiotomy (-6)</option>
                                        <option value="other">Other (0)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Cardiovascular -->
                            <div class="save-category">
                                <h4>Cardiovascular</h4>
                                
                                <div class="form-group">
                                    <label>Diastolic BP pre-ECMO <40 mmHg <span class="required">*</span></label>
                                    <select id="save_dbp">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (-3)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Pulse Pressure pre-ECMO <20 mmHg <span class="required">*</span></label>
                                    <select id="save_pp">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (-2)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Pre-ECMO Cardiac Arrest <span class="required">*</span></label>
                                    <select id="save_arrest">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (-2)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Respiratory -->
                            <div class="save-category">
                                <h4>Respiratory</h4>
                                
                                <div class="form-group">
                                    <label>Pre-ECMO Ventilation Duration <span class="required">*</span></label>
                                    <select id="save_ventilation">
                                        <option value="">Select...</option>
                                        <option value="short">≤10 hours (0)</option>
                                        <option value="medium">11-29 hours (-2)</option>
                                        <option value="long">≥30 hours (-4)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>PaCO₂ >45 mmHg (6 kPa) <span class="required">*</span></label>
                                    <select id="save_paco2">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (-3)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Peak Inspiratory Pressure >20 cmH₂O <span class="required">*</span></label>
                                    <select id="save_pip">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (-2)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- RIGHT COLUMN -->
                        <div>
                            <!-- Metabolic -->
                            <div class="save-category">
                                <h4>Metabolic</h4>
                                
                                <div class="form-group">
                                    <label>Bicarbonate <15 mmol/L <span class="required">*</span></label>
                                    <select id="save_bicarb">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes (-3)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Renal -->
                            <div class="save-category">
                                <h4>Renal</h4>
                                
                                <div class="form-group">
                                    <label>Renal Status <span class="required">*</span></label>
                                    <select id="save_renal">
                                        <option value="">Select...</option>
                                        <option value="normal">Normal (0)</option>
                                        <option value="acute">Acute renal failure - Creatinine >133 µmol/L (-3)</option>
                                        <option value="chronic">Chronic renal failure - On dialysis pre-ECMO (-6)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Hepatic -->
                            <div class="save-category">
                                <h4>Hepatic</h4>
                                
                                <div class="form-group">
                                    <label>Liver Failure <span class="required">*</span></label>
                                    <select id="save_liver">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes - Bilirubin >33 µmol/L and/or Transaminase >70 U/L (-3)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- CNS / Neurological -->
                            <div class="save-category">
                                <h4>Central Nervous System</h4>
                                
                                <div class="form-group">
                                    <label>CNS Dysfunction <span class="required">*</span></label>
                                    <select id="save_cns">
                                        <option value="">Select...</option>
                                        <option value="yes">Yes - Neurotrauma, stroke, encephalopathy, cerebral embolism, seizures (-3)</option>
                                        <option value="no">No (0)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calculate Button -->
            <button class="calculate-btn" onclick="calculate()">
                CALCULATE ASSESSMENT
            </button>
            
            <!-- Results Section -->
            <div id="results" class="results-section">
                <h2 style="text-align: center; margin-bottom: 20px; color: #333;">ASSESSMENT RESULTS</h2>
                
                <div class="results-grid">
                    <div class="result-box danger">
                        <div class="result-label">Absolute Contraindications</div>
                        <div class="result-value" id="result_contra">-</div>
                    </div>
                    
                    <div class="result-box info">
                        <div class="result-label">SCAI Classification</div>
                        <div style="margin-top: 8px;">
                            <div style="margin-bottom: 4px;"><strong>Stage:</strong> <span id="result_scai">-</span></div>
                            <div><strong>Predicted Mortality:</strong> <span id="result_scai_mortality">-</span></div>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <div class="result-label">CardShock Score</div>
                        <div style="margin-top: 8px;">
                            <div style="margin-bottom: 4px;"><strong>Score:</strong> <span id="result_cardshock">-</span></div>
                            <div><strong>Mortality Risk:</strong> <span id="result_cardshock_mort">-</span></div>
                        </div>
                    </div>
                    
                    <div class="result-box">
                        <div class="result-label">SAVE Score</div>
                        <div style="margin-top: 8px;">
                            <div style="margin-bottom: 4px;"><strong>Score:</strong> <span id="result_save">-</span></div>
                            <div style="margin-bottom: 4px;"><strong>Risk Class:</strong> <span id="result_save_class">-</span></div>
                            <div><strong>Predicted Survival:</strong> <span id="result_save_survival">-</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Clinical Decision Framework -->
                <div class="decision-box">
                    <h3>Clinical Decision Framework</h3>
                    <div class="decision-item">
                        <strong>SCAI-E Total Score:</strong> <span id="decision_scai_e_total">-</span>
                    </div>
                    <div class="decision-item">
                        <strong>Risk of death WITHOUT ECMO:</strong> <span id="decision_without_ecmo">-</span>
                    </div>
                    <div class="decision-item">
                        <strong>Risk of death WITH ECMO:</strong> <span id="decision_with_ecmo">-</span>
                    </div>
                    <div class="decision-item">
                        <strong>Benefit from ECMO:</strong> <span id="decision_benefit">-</span>
                    </div>
                    <div class="decision-item">
                        <strong>ECMO complications risk:</strong> <span id="decision_complications">-</span>
                    </div>
                </div>
                
                <div class="final-recommendation" id="final_recommendation">
                    Complete assessment to see recommendation
                </div>
                
                <!-- Print Buttons -->
                <div class="print-buttons">
                    <button class="print-btn" onclick="printPDF()">📄 Download PDF Summary</button>
                    <button class="print-btn" onclick="printPlainText()">📝 Download Text Summary</button>
                    <button class="print-btn" onclick="window.print()">🖨️ Print Assessment</button>
                </div>
                
                <!-- Notes Section -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 15px;">Clinical Notes & Discussion</h3>
                    
                    <div class="form-group">
                        <label>Additional Clinical Considerations</label>
                        <textarea class="notes-area" id="clinical_notes" placeholder="Document relevant clinical factors, comorbidities, trajectory..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>MDT Discussion Points</label>
                        <textarea class="notes-area" id="mdt_notes" placeholder="Record MDT discussion, consultant opinions, specialist input..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Family Discussion Summary</label>
                        <textarea class="notes-area" id="family_notes" placeholder="Document family discussion, understanding, wishes..."></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Assessment Completed By</label>
                            <input type="text" id="assessor" placeholder="Name and role">
                        </div>
                        <div class="form-group">
                            <label>Sign-off Date/Time</label>
                            <input type="datetime-local" id="signoffDate">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Hospital database with distances and times
        const hospitalData = {
            england: {
                Bristol: [
                    {name: 'Bristol Royal Infirmary (BRI)', distance: 0.0, time: 0, contact: '0117 923 0000'},
                    {name: 'Southmead Hospital', distance: 4.0, time: 3, contact: '0117 950 5050'}
                ],
                Cornwall: [
                    {name: 'Royal Cornwall Hospital (Treliske), Truro', distance: 219.7, time: 165, contact: '01872 250000'}
                ],
                Devon: [
                    {name: 'North Devon District Hospital (Barnstaple)', distance: 109.1, time: 82, contact: '01271 322577'},
                    {name: 'Royal Devon & Exeter Hospital (Wonford), Exeter', distance: 103.0, time: 77, contact: '01392 411611'},
                    {name: 'Derriford Hospital, Plymouth', distance: 157.3, time: 118, contact: '01752 202082'}
                ],
                Dorset: [
                    {name: 'Dorset County Hospital, Dorchester', distance: 83.7, time: 63, contact: '01305 251150'}
                ],
                Gloucestershire: [
                    {name: 'Gloucestershire Royal Hospital, Gloucester', distance: 51.8, time: 39, contact: '0300 422 2222'},
                    {name: 'Cheltenham General Hospital, Cheltenham', distance: 60.2, time: 45, contact: '0845 422 4721'}
                ],
                Somerset: [
                    {name: 'Royal United Hospital, Bath', distance: 16.1, time: 12, contact: '01225 428331'},
                    {name: 'Weston General Hospital', distance: 30.2, time: 23, contact: '01934 636363'},
                    {name: 'Yeovil District Hospital, Yeovil', distance: 57.3, time: 43, contact: '01935 475122'},
                    {name: 'Musgrove Park Hospital (Taunton)', distance: 61.0, time: 46, contact: '01823 333444'}
                ],
                Wiltshire: [
                    {name: 'Great Western Hospital, Swindon', distance: 60.8, time: 46, contact: '01793 604020'}
                ]
            },
            wales: {
                Cardiff_South_Glamorgan: [
                    {name: 'University Hospital of Wales, Cardiff (UHW)', distance: 41.4, time: 31, contact: '029 2074 7747'}
                ],
                Carmarthenshire: [
                    {name: 'Glangwili General Hospital, Carmarthen', distance: 126.4, time: 95, contact: '01267 235151'}
                ],
                Merthyr_Tydfil: [
                    {name: 'Prince Charles Hospital, Merthyr Tydfil', distance: 64.2, time: 48, contact: '01685 721721'}
                ],
                Monmouthshire: [
                    {name: 'Nevill Hall Hospital, Abergavenny', distance: 50.6, time: 38, contact: '01873 732732'}
                ],
                Neath_Port_Talbot: [
                    {name: 'Neath Port Talbot Hospital, Port Talbot', distance: 84.8, time: 64, contact: '01639 862000'}
                ],
                Newport_Gwent: [
                    {name: 'Royal Gwent Hospital, Newport', distance: 30.9, time: 23, contact: '01633 234234'}
                ],
                Swansea: [
                    {name: 'Morriston Hospital, Swansea', distance: 95.9, time: 72, contact: '01792 702222'},
                    {name: 'Singleton Hospital, Swansea', distance: 97.5, time: 73, contact: '01792 205666'}
                ]
            }
        };
        
        // Toggle section visibility
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.toggle');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggle.textContent = '−';
                header.classList.remove('collapsed');
            } else {
                content.classList.add('hidden');
                toggle.textContent = '+';
                header.classList.add('collapsed');
            }
        }
        
        // Update contraindication visual state
        function updateContraindication(contraId) {
            const checkbox = document.getElementById(contraId);
            const box = document.getElementById(contraId + '_box');
            
            if (checkbox.checked) {
                box.classList.add('contraindication-present');
            } else {
                box.classList.remove('contraindication-present');
            }
        }
        
        // Calculate SCAI-E scores immediately
        function calculateSCAIE() {
            let aetiologyScore = 0;
            let onsetScore = 0;
            let comorbidityScore = 0;
            let scaiETotal = 0;
            
            const aetiologyVal = document.getElementById('scai_e_aetiology').value;
            const onsetVal = document.getElementById('scai_e_onset').value;
            
            if (aetiologyVal) {
                aetiologyScore = parseInt(aetiologyVal);
            }
            
            if (onsetVal) {
                onsetScore = parseInt(onsetVal);
            }
            
            // Comorbidity - any present = 1
            const anyComorbid = 
                document.getElementById('comorbid1').checked ||
                document.getElementById('comorbid2').checked ||
                document.getElementById('comorbid3').checked ||
                document.getElementById('comorbid4').checked ||
                document.getElementById('comorbid5').checked ||
                document.getElementById('comorbid6').checked ||
                document.getElementById('comorbid7').checked;
            
            comorbidityScore = anyComorbid ? 1 : 0;
            
            // Total SCAI-E score
            scaiETotal = aetiologyScore + onsetScore + comorbidityScore;
            
            // Update individual displays
            document.getElementById('aetiology_score_display').textContent = aetiologyScore > 0 ? aetiologyScore : 'Not selected';
            document.getElementById('onset_score_display').textContent = onsetVal ? onsetScore : 'Not selected';
            document.getElementById('comorbidity_score_display').textContent = comorbidityScore;
            
            document.getElementById('aetiology_component').textContent = aetiologyScore > 0 ? aetiologyScore : '-';
            document.getElementById('onset_component').textContent = onsetVal ? onsetScore : '-';
            document.getElementById('comorbidity_component').textContent = comorbidityScore;
            document.getElementById('scai_e_total').textContent = scaiETotal > 0 ? scaiETotal + ' / 6' : 'Incomplete';
            
            // Calculate age-based risk display
            const patientAge = parseInt(document.getElementById('age').value) || 0;
            const scaiERiskDisplay = document.getElementById('scai_e_risk_display');
            
            if (scaiETotal > 0 && patientAge > 0) {
                let riskCategory = '';
                let riskColor = '';
                let riskText = '';
                
                if (patientAge < 40) {
                    if (scaiETotal <= 3) {
                        riskCategory = 'HIGHLY FAVOURABLE';
                        riskColor = '#28a745';
                        riskText = 'Excellent ECMO candidacy profile for age group';
                    } else if (scaiETotal === 4) {
                        riskCategory = 'INTERMEDIATE RISK';
                        riskColor = '#ffc107';
                        riskText = 'Moderate risk profile, careful assessment required';
                    } else {
                        riskCategory = 'HIGH RISK';
                        riskColor = '#dc3545';
                        riskText = 'Unfavourable profile, consider very carefully';
                    }
                } else if (patientAge >= 40 && patientAge < 65) {
                    if (scaiETotal <= 2) {
                        riskCategory = 'HIGHLY FAVOURABLE';
                        riskColor = '#28a745';
                        riskText = 'Good ECMO candidacy profile for age group';
                    } else if (scaiETotal === 3) {
                        riskCategory = 'INTERMEDIATE RISK';
                        riskColor = '#ffc107';
                        riskText = 'Moderate risk profile, careful assessment required';
                    } else if (scaiETotal === 4) {
                        riskCategory = 'HIGH RISK';
                        riskColor = '#dc3545';
                        riskText = 'High risk profile, detailed MDT discussion essential';
                    } else {
                        riskCategory = 'INAPPROPRIATE';
                        riskColor = '#001f3f';
                        riskText = 'ECMO generally inappropriate for this risk profile';
                    }
                } else { // age >= 65
                    if (scaiETotal <= 2) {
                        riskCategory = 'INTERMEDIATE RISK';
                        riskColor = '#ffc107';
                        riskText = 'Moderate risk profile for older patient';
                    } else if (scaiETotal === 3) {
                        riskCategory = 'HIGH RISK';
                        riskColor = '#dc3545';
                        riskText = 'High risk profile, exceptional circumstances only';
                    } else {
                        riskCategory = 'INAPPROPRIATE';
                        riskColor = '#001f3f';
                        riskText = 'ECMO generally inappropriate for this risk profile';
                    }
                }
                
                scaiERiskDisplay.innerHTML = `
                    <div style="background: ${riskColor}; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">${riskCategory}</div>
                        <div style="font-size: 16px;">Age: ${patientAge} years | SCAI-E Total: ${scaiETotal}/6</div>
                        <div style="font-size: 14px; margin-top: 10px; opacity: 0.95;">${riskText}</div>
                    </div>
                `;
            } else if (scaiETotal > 0 && patientAge === 0) {
                scaiERiskDisplay.innerHTML = `
                    <div class="warning-banner">
                        <strong>SCAI-E score calculated (${scaiETotal}/6) but patient age required for risk stratification</strong>
                    </div>
                `;
            } else if (scaiETotal === 0 && patientAge > 0) {
                scaiERiskDisplay.innerHTML = `
                    <div class="warning-banner">
                        <strong>Complete SCAI-E scores to see age-adjusted risk category (Patient age: ${patientAge} years)</strong>
                    </div>
                `;
            } else {
                scaiERiskDisplay.innerHTML = `
                    <div class="warning-banner">
                        <strong>Complete patient age and SCAI-E scores to see age-adjusted risk category</strong>
                    </div>
                `;
            }
        }
        
        // Calculate BMI and IBW
        function calculateBMIandIBW() {
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const sex = document.getElementById('sex').value;
            
            // Calculate BMI
            if (weight && height) {
                const heightM = height / 100;
                const bmi = (weight / (heightM * heightM)).toFixed(1);
                document.getElementById('bmi').value = bmi;
                
                // Calculate BSA using Mosteller formula: BSA = sqrt((height_cm × weight_kg) / 3600)
                const bsa = Math.sqrt((height * weight) / 3600).toFixed(2);
                document.getElementById('bsa').value = bsa;
            } else {
                document.getElementById('bmi').value = '';
                document.getElementById('bsa').value = '';
            }
            
            // Calculate IBW using Devine formula
            if (height && sex) {
                let ibw;
                if (sex === 'male') {
                    // Male: 50 kg + 2.3 kg per inch over 5 feet
                    ibw = 50 + 2.3 * ((height / 2.54) - 60);
                } else if (sex === 'female') {
                    // Female: 45.5 kg + 2.3 kg per inch over 5 feet
                    ibw = 45.5 + 2.3 * ((height / 2.54) - 60);
                } else {
                    ibw = null;
                }
                
                if (ibw) {
                    document.getElementById('ibw').value = ibw.toFixed(1);
                } else {
                    document.getElementById('ibw').value = '';
                }
            } else {
                document.getElementById('ibw').value = '';
            }
            
            updateSaveDisplays();
            updateCalculations(); // Update calculations table when IBW changes
            calculateAll(); // Update SCAI-E risk display when age changes
        }
        
        // Update SAVE score displays
        function updateSaveDisplays() {
            const age = parseInt(document.getElementById('age').value);
            const weight = parseFloat(document.getElementById('weight').value);
            
            if (age) {
                if (age >= 18 && age <= 38) {
                    document.getElementById('save_age_display').value = '18-38 years (+7)';
                } else if (age <= 52) {
                    document.getElementById('save_age_display').value = '39-52 years (+4)';
                } else if (age <= 62) {
                    document.getElementById('save_age_display').value = '53-62 years (+3)';
                } else {
                    document.getElementById('save_age_display').value = '≥63 years (0)';
                }
            } else {
                document.getElementById('save_age_display').value = '';
            }
            
            if (weight) {
                if (weight < 65) {
                    document.getElementById('save_weight_display').value = '<65 kg (+1)';
                } else if (weight < 90) {
                    document.getElementById('save_weight_display').value = '65-89 kg (+2)';
                } else {
                    document.getElementById('save_weight_display').value = '≥90 kg (0)';
                }
            } else {
                document.getElementById('save_weight_display').value = '';
            }
        }
        
        // Update counties based on region
        function updateCounties() {
            const region = document.getElementById('region').value;
            const countySelect = document.getElementById('county');
            const hospitalSelect = document.getElementById('hospital');
            
            countySelect.innerHTML = '<option value="">Select...</option>';
            hospitalSelect.innerHTML = '<option value="">Select county first</option>';
            document.getElementById('distance').value = '';
            document.getElementById('drivingTime').value = '';
            
            if (region === 'england') {
                Object.keys(hospitalData.england).forEach(county => {
                    const option = document.createElement('option');
                    option.value = county;
                    option.textContent = county.replace(/_/g, ' ');
                    countySelect.appendChild(option);
                });
            } else if (region === 'wales') {
                Object.keys(hospitalData.wales).forEach(county => {
                    const option = document.createElement('option');
                    option.value = county;
                    option.textContent = county.replace(/_/g, ' ');
                    countySelect.appendChild(option);
                });
            }
        }
        
        // Update hospitals based on county
        function updateHospitals() {
            const region = document.getElementById('region').value;
            const county = document.getElementById('county').value;
            const hospitalSelect = document.getElementById('hospital');
            
            hospitalSelect.innerHTML = '<option value="">Select...</option>';
            document.getElementById('distance').value = '';
            document.getElementById('drivingTime').value = '';
            
            if (region && county) {
                const hospitals = hospitalData[region][county] || [];
                hospitals.forEach((hospital, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = hospital.name;
                    option.dataset.distance = hospital.distance;
                    option.dataset.time = hospital.time;
                    hospitalSelect.appendChild(option);
                });
            }
        }
        
        // Update distance and time based on hospital
        function updateDistanceTime() {
            const region = document.getElementById('region').value;
            const county = document.getElementById('county').value;
            const hospitalSelect = document.getElementById('hospital');
            const selectedIndex = hospitalSelect.value;
            
            if (region && county && selectedIndex !== '') {
                const hospital = hospitalData[region][county][parseInt(selectedIndex)];
                document.getElementById('distance').value = hospital.distance;
                document.getElementById('drivingTime').value = hospital.time;
                
                // Auto-populate ICU contact if available
                if (hospital.contact) {
                    document.getElementById('icuContact').value = hospital.contact;
                } else {
                    document.getElementById('icuContact').value = 'Contact number not available';
                }
            }
        }
        

        // Auto-calculate SCAI stage based on clinical criteria
        function autoCalculateSCAI() {
            // Get all clinical parameters
            const ph = parseFloat(document.getElementById('scai_ph').value);
            const lactate = parseFloat(document.getElementById('scai_lactate').value);
            const response = document.getElementById('scai_response').value;
            const sbp_val = document.getElementById('scai_bp').value;
            const perfusion = document.getElementById('scai_perfusion').value;
            const support = document.getElementById('scai_support').value;
            const renal = document.getElementById('scai_renal').value;
            const liver = document.getElementById('scai_liver').value;
            const cardiacArrest = document.getElementById('cardiac_arrest').value;
            
            let calculatedStage = '';
            let mortality = '';
            
            // Priority order classification (highest severity first)
            
            // STAGE E: pH<7.2 OR lactate>5 OR recurrent CPR/pressors
            if (ph > 0 && ph < 7.2) {
                calculatedStage = 'E';
            } else if (lactate > 5) {
                calculatedStage = 'E';
            } else if (response === 'recurrent') {
                calculatedStage = 'E';
            }
            
            // STAGE D: Lactate >2 and rising OR escalating pressors OR worsening organ function
            else if (lactate > 2 && (response === 'refractory' || response === 'partial')) {
                calculatedStage = 'D';
            } else if (support === 'escalating') {
                calculatedStage = 'D';
            } else if ((liver === 'moderate' || liver === 'severe') && response !== 'stabilised') {
                calculatedStage = 'D';
            } else if ((renal === 'moderate' || renal === 'severe') && response !== 'stabilised') {
                calculatedStage = 'D';
            }
            
            // STAGE C: Lactate ≥2 OR any pressor/MCS OR hypoperfusion signs
            else if (lactate >= 2) {
                calculatedStage = 'C';
            } else if (support === 'single_low' || support === 'single_high' || support === 'multiple') {
                calculatedStage = 'C';
            } else if (perfusion === 'impaired' || perfusion === 'severe') {
                calculatedStage = 'C';
            }
            
            // STAGE B: Hypotension or tachycardia without hypoperfusion
            else if (sbp_val === 'low' && perfusion !== 'impaired' && perfusion !== 'severe') {
                calculatedStage = 'B';
            } else if (perfusion === 'borderline') {
                calculatedStage = 'B';
            }
            
            // STAGE A: Default if no criteria met
            else if (sbp_val === 'normal' || sbp_val === '') {
                calculatedStage = 'A';
            }
            
            // Update display
            if (calculatedStage) {
                document.getElementById('scai_auto').value = 'Stage ' + calculatedStage;
                
                // Calculate mortality based on stage and cardiac arrest
                if (cardiacArrest === 'no') {
                    const mortalityNoCA = {
                        'A': '-',
                        'B': '5%',
                        'C': '8%',
                        'D': '32%',
                        'E': '55%'
                    };
                    mortality = mortalityNoCA[calculatedStage];
                } else if (cardiacArrest === 'yes') {
                    const mortalityWithCA = {
                        'A': '-',
                        'B': '26%',
                        'C': '40%',
                        'D': '54%',
                        'E': '77%'
                    };
                    mortality = mortalityWithCA[calculatedStage];
                }
                
                if (mortality) {
                    document.getElementById('scai_mortality').value = mortality + ' in-hospital mortality';
                }
                
                // Auto-populate the manual override field (but user can change)
                const manualField = document.getElementById('scai');
                if (!manualField.value || manualField.value === '') {
                    manualField.value = calculatedStage;
                }
            } else {
                document.getElementById('scai_auto').value = 'Insufficient data for classification';
                document.getElementById('scai_mortality').value = '';
            }
        }

                // Main calculation function
        function calculate() {
            // Check for absolute contraindications
            const contraindications = [];
            for (let i = 1; i <= 9; i++) {
                if (document.getElementById(`contra${i}`).checked) {
                    contraindications.push(i);
                }
            }
            const anyContra = contraindications.length > 0;
            
            // Get SCAI stage
            // Use manual override if set, otherwise use auto-calculated
            let scaiStage = document.getElementById('scai').value;
            if (!scaiStage || scaiStage === '') {
                // Extract stage letter from auto-calculated field
                const autoCalc = document.getElementById('scai_auto').value;
                if (autoCalc && autoCalc.includes('Stage ')) {
                    scaiStage = autoCalc.replace('Stage ', '').trim();
                }
            }
            
            // Get cardiac arrest status for mortality
            const cardiacArrest = document.getElementById('cardiac_arrest').value;
            
            // Calculate CardShock score
            let cardshockScore = 0;
            const cardshockParams = [
                {id: 'cardshock_confusion', points: 3},
                {id: 'cardshock_previous_acs', points: 2},
                {id: 'cardshock_lactate', points: 2},
                {id: 'cardshock_egfr', points: 2}
            ];
            
            cardshockParams.forEach(param => {
                const value = document.getElementById(param.id).value;
                if (value === 'yes') {
                    cardshockScore += param.points;
                }
            });
            
            let cardshockMortality = '';
            if (cardshockScore <= 1) {
                cardshockMortality = '6.3%';
            } else if (cardshockScore <= 3) {
                cardshockMortality = '18.8%';
            } else if (cardshockScore <= 5) {
                cardshockMortality = '41.1%';
            } else {
                cardshockMortality = '79.4%';
            }
            
            // Calculate SAVE score with CORRECTED SURVIVAL VALUES
            let saveScore = -6; // Constant
            let saveComplete = true;
            
            // Age points
            const age = parseInt(document.getElementById('age').value);
            if (age) {
                if (age >= 18 && age <= 38) {
                    saveScore += 7;
                } else if (age <= 52) {
                    saveScore += 4;
                } else if (age <= 62) {
                    saveScore += 3;
                } else {
                    saveScore += 0;
                }
            } else {
                saveComplete = false;
            }
            
            // Weight points
            const weight = parseFloat(document.getElementById('weight').value);
            if (weight) {
                if (weight < 65) {
                    saveScore += 1;
                } else if (weight < 90) {
                    saveScore += 2;
                } else {
                    saveScore += 0;
                }
            } else {
                saveComplete = false;
            }
            
            // Diagnosis
            const diagnosis = document.getElementById('save_diagnosis').value;
            if (diagnosis) {
                const diagnosisPoints = {
                    'myocarditis': 3,
                    'vtfvf': 2,
                    'transplant': 3,
                    'chd': -3,
                    'cardiotomy': -6,
                    'other': 0
                };
                saveScore += diagnosisPoints[diagnosis] || 0;
            } else {
                saveComplete = false;
            }
            
            // Ventilation duration
            const ventilation = document.getElementById('save_ventilation').value;
            if (ventilation) {
                const ventPoints = {
                    'short': 0,
                    'medium': -2,
                    'long': -4
                };
                saveScore += ventPoints[ventilation] || 0;
            } else {
                saveComplete = false;
            }
            
            // Renal function
            const renal = document.getElementById('save_renal').value;
            if (renal) {
                const renalPoints = {
                    'normal': 0,
                    'acute': -3,
                    'chronic': -6
                };
                saveScore += renalPoints[renal] || 0;
            } else {
                saveComplete = false;
            }
            
            // Binary parameters (including NEW liver and CNS)
            const binaryParams = [
                {id: 'save_dbp', points: -3},
                {id: 'save_pp', points: -2},
                {id: 'save_arrest', points: -2},
                {id: 'save_bicarb', points: -3},
                {id: 'save_paco2', points: -3},
                {id: 'save_pip', points: -2},
                {id: 'save_liver', points: -3},
                {id: 'save_cns', points: -3}
            ];
            
            binaryParams.forEach(param => {
                const value = document.getElementById(param.id).value;
                if (value === 'yes') {
                    saveScore += param.points;
                } else if (value === '') {
                    saveComplete = false;
                }
            });
            
            // CORRECTED SAVE risk class and survival values
            let saveClass = '';
            let saveSurvival = '';
            let saveDeathRate = '';
            
            if (saveComplete) {
                if (saveScore > 5) {
                    saveClass = 'I';
                    saveSurvival = '75%';
                    saveDeathRate = '25%';
                } else if (saveScore >= 1) {
                    saveClass = 'II';
                    saveSurvival = '58%';
                    saveDeathRate = '42%';
                } else if (saveScore >= -4) {
                    saveClass = 'III';
                    saveSurvival = '42%';
                    saveDeathRate = '58%';
                } else if (saveScore >= -9) {
                    saveClass = 'IV';
                    saveSurvival = '30%';
                    saveDeathRate = '70%';
                } else {
                    saveClass = 'V';
                    saveSurvival = '18%';
                    saveDeathRate = '82%';
                }
            }
            
            // Calculate clinical decision framework
            let deathWithoutECMO = 'Very High (>90%)';
            let deathWithECMO = saveDeathRate || 'Unknown';
            let benefit = 'Unknown';
            let complications = 'Moderate to High';
            
            // Risk of death without ECMO based on SCAI stage and CardShock
            if (scaiStage === 'E') {
                deathWithoutECMO = 'Very High (>90%)';
            } else if (scaiStage === 'D') {
                deathWithoutECMO = 'High (70-90%)';
            } else if (scaiStage === 'C') {
                deathWithoutECMO = 'Moderate-High (40-70%)';
            } else {
                deathWithoutECMO = cardshockMortality;
            }
            
            // Calculate benefit
            if (saveComplete) {
                const survivalNum = parseInt(saveSurvival);
                if (survivalNum >= 58) {
                    benefit = 'High - Significant survival benefit expected';
                } else if (survivalNum >= 42) {
                    benefit = 'Moderate - Potential survival benefit';
                } else if (survivalNum >= 30) {
                    benefit = 'Uncertain - Limited benefit expected';
                } else {
                    benefit = 'Low - Minimal expected benefit';
                }
            }
            
            // Complications risk
            const frailty = parseInt(document.getElementById('frailty').value);
            if (frailty >= 7 || age > 75) {
                complications = 'High - Consider carefully';
            } else if (frailty >= 5 || age > 65) {
                complications = 'Moderate-High - Discuss risks';
            } else {
                complications = 'Moderate - Standard ECMO risks';
            }
            
            
            // Calculate SCAI-E scores (for Stage E patients)
            let aetiologyScore = 0;
            let onsetScore = 0;
            let comorbidityScore = 0;
            let scaiETotal = 0;
            
            const aetiologyVal = document.getElementById('scai_e_aetiology').value;
            const onsetVal = document.getElementById('scai_e_onset').value;
            
            if (aetiologyVal) {
                aetiologyScore = parseInt(aetiologyVal);
            }
            
            if (onsetVal) {
                onsetScore = parseInt(onsetVal);
            }
            
            // Comorbidity - any present = 1
            const anyComorbid = 
                document.getElementById('comorbid1').checked ||
                document.getElementById('comorbid2').checked ||
                document.getElementById('comorbid3').checked ||
                document.getElementById('comorbid4').checked ||
                document.getElementById('comorbid5').checked ||
                document.getElementById('comorbid6').checked ||
                document.getElementById('comorbid7').checked;
            
            comorbidityScore = anyComorbid ? 1 : 0;
            
            // Total SCAI-E score
            scaiETotal = aetiologyScore + onsetScore + comorbidityScore;
            
            // Update SCAI-E displays
            document.getElementById('aetiology_score_display').textContent = aetiologyScore > 0 ? aetiologyScore : 'Not selected';
            document.getElementById('onset_score_display').textContent = onsetVal ? onsetScore : 'Not selected';
            document.getElementById('comorbidity_score_display').textContent = comorbidityScore;
            
            document.getElementById('aetiology_component').textContent = aetiologyScore > 0 ? aetiologyScore : '-';
            document.getElementById('onset_component').textContent = onsetVal ? onsetScore : '-';
            document.getElementById('comorbidity_component').textContent = comorbidityScore;
            document.getElementById('scai_e_total').textContent = scaiETotal > 0 ? scaiETotal + ' / 6' : 'Incomplete';
            
            // Calculate age-based SCAI-E risk category
            const patientAge = parseInt(document.getElementById('age').value) || 0;
            const scaiERiskDisplay = document.getElementById('scai_e_risk_display');
            
            if (scaiETotal > 0 && patientAge > 0) {
                let riskCategory = '';
                let riskColor = '';
                let riskText = '';
                
                if (patientAge < 40) {
                    if (scaiETotal <= 3) {
                        riskCategory = 'HIGHLY FAVOURABLE';
                        riskColor = '#28a745';
                        riskText = 'Excellent ECMO candidacy profile for age group';
                    } else if (scaiETotal === 4) {
                        riskCategory = 'INTERMEDIATE RISK';
                        riskColor = '#ffc107';
                        riskText = 'Moderate risk profile, careful assessment required';
                    } else {
                        riskCategory = 'HIGH RISK';
                        riskColor = '#dc3545';
                        riskText = 'Unfavourable profile, consider very carefully';
                    }
                } else if (patientAge >= 40 && patientAge < 65) {
                    if (scaiETotal <= 2) {
                        riskCategory = 'HIGHLY FAVOURABLE';
                        riskColor = '#28a745';
                        riskText = 'Good ECMO candidacy profile for age group';
                    } else if (scaiETotal === 3) {
                        riskCategory = 'INTERMEDIATE RISK';
                        riskColor = '#ffc107';
                        riskText = 'Moderate risk profile, careful assessment required';
                    } else if (scaiETotal === 4) {
                        riskCategory = 'HIGH RISK';
                        riskColor = '#dc3545';
                        riskText = 'High risk profile, detailed MDT discussion essential';
                    } else {
                        riskCategory = 'INAPPROPRIATE';
                        riskColor = '#001f3f';
                        riskText = 'ECMO generally inappropriate for this risk profile';
                    }
                } else { // age >= 65
                    if (scaiETotal <= 2) {
                        riskCategory = 'INTERMEDIATE RISK';
                        riskColor = '#ffc107';
                        riskText = 'Moderate risk profile for older patient';
                    } else if (scaiETotal === 3) {
                        riskCategory = 'HIGH RISK';
                        riskColor = '#dc3545';
                        riskText = 'High risk profile, exceptional circumstances only';
                    } else {
                        riskCategory = 'INAPPROPRIATE';
                        riskColor = '#001f3f';
                        riskText = 'ECMO generally inappropriate for this risk profile';
                    }
                }
                
                scaiERiskDisplay.innerHTML = `
                    <div style="background: ${riskColor}; color: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">${riskCategory}</div>
                        <div style="font-size: 16px;">Age: ${patientAge} years | SCAI-E Total: ${scaiETotal}/6</div>
                        <div style="font-size: 14px; margin-top: 10px; opacity: 0.95;">${riskText}</div>
                    </div>
                `;
            } else if (scaiETotal > 0 && patientAge === 0) {
                scaiERiskDisplay.innerHTML = `
                    <div class="warning-banner">
                        <strong>SCAI-E score calculated (${scaiETotal}/6) but patient age required for risk stratification</strong>
                    </div>
                `;
            } else if (scaiETotal === 0 && patientAge > 0) {
                scaiERiskDisplay.innerHTML = `
                    <div class="warning-banner">
                        <strong>Complete SCAI-E scores to see age-adjusted risk category (Patient age: ${patientAge} years)</strong>
                    </div>
                `;
            } else {
                scaiERiskDisplay.innerHTML = `
                    <div class="warning-banner">
                        <strong>Complete patient age and SCAI-E scores to see age-adjusted risk category</strong>
                    </div>
                `;
            }
            
            // Determine final recommendation incorporating SCAI-E
            let finalRec = '';
            let recClass = '';
            
            // SCAI-E risk modification (for Stage E patients)
            let scaiEModifier = '';
            if (scaiStage === 'E' && scaiETotal > 0 && patientAge > 0) {
                if (patientAge < 40) {
                    if (scaiETotal <= 3) {
                        scaiEModifier = ' (SCAI-E: Highly favourable)';
                    } else if (scaiETotal === 4) {
                        scaiEModifier = ' (SCAI-E: Intermediate risk)';
                    } else {
                        scaiEModifier = ' (SCAI-E: High risk - consider very carefully)';
                    }
                } else if (patientAge >= 40 && patientAge < 65) {
                    if (scaiETotal <= 2) {
                        scaiEModifier = ' (SCAI-E: Highly favourable)';
                    } else if (scaiETotal === 3) {
                        scaiEModifier = ' (SCAI-E: Intermediate risk)';
                    } else if (scaiETotal === 4) {
                        scaiEModifier = ' (SCAI-E: High risk)';
                    } else {
                        scaiEModifier = ' (SCAI-E: Inappropriate risk profile)';
                    }
                } else { // age >= 65
                    if (scaiETotal <= 2) {
                        scaiEModifier = ' (SCAI-E: Intermediate risk)';
                    } else if (scaiETotal === 3) {
                        scaiEModifier = ' (SCAI-E: High risk)';
                    } else {
                        scaiEModifier = ' (SCAI-E: Inappropriate risk profile)';
                    }
                }
            }
            
            if (anyContra) {
                finalRec = 'DECLINE - Absolute contraindication present';
                recClass = 'danger';
            } else if (!saveComplete) {
                finalRec = 'INCOMPLETE - Complete all SAVE score parameters';
                recClass = 'info';
            } else if (saveClass === 'V') {
                finalRec = 'DECLINE - Very poor predicted survival (18%) with high ECMO risks';
                recClass = 'danger';
            } else if (saveClass === 'IV') {
                finalRec = 'DISCUSS - Poor survival (30%) but consider if no alternatives and acceptable to patient/family';
                recClass = 'danger';
            } else if (saveClass === 'I' && (scaiStage === 'D' || scaiStage === 'E')) {
                finalRec = 'ACCEPT - High survival probability (75%) with significant mortality risk without ECMO' + scaiEModifier;
                recClass = 'success';
            } else if (saveClass === 'II' && scaiStage === 'E') {
                finalRec = 'ACCEPT - Moderate-good survival probability (58%) with extremely high risk without support' + scaiEModifier;
                recClass = 'success';
            } else if (saveClass === 'I' || saveClass === 'II') {
                finalRec = 'DISCUSS - Good survival probability (≥58%), evaluate benefit vs risk with MDT';
                recClass = 'info';
            } else if (saveClass === 'III') {
                finalRec = 'DISCUSS - Borderline survival probability (42%), careful assessment of appropriateness required';
                recClass = 'info';
            } else {
                finalRec = 'DISCUSS - Complex case requiring detailed MDT review';
                recClass = 'info';
            }
            
            // Update results display
            document.getElementById('result_contra').textContent = anyContra ? 'PRESENT - STOP' : 'None identified';
            document.getElementById('result_contra').parentElement.className = anyContra ? 'result-box danger' : 'result-box success';
            
            document.getElementById('result_scai').textContent = scaiStage || 'Not selected';
            
            // Display SCAI mortality
            let scaiMortality = '';
            if (scaiStage && cardiacArrest) {
                if (cardiacArrest === 'no') {
                    const mortalityNoCA = {'A': '-', 'B': '5%', 'C': '8%', 'D': '32%', 'E': '55%'};
                    scaiMortality = mortalityNoCA[scaiStage] || '';
                } else if (cardiacArrest === 'yes') {
                    const mortalityWithCA = {'A': '-', 'B': '26%', 'C': '40%', 'D': '54%', 'E': '77%'};
                    scaiMortality = mortalityWithCA[scaiStage] || '';
                }
                if (scaiMortality && scaiMortality !== '-') {
                    scaiMortality += ' (CA: ' + (cardiacArrest === 'yes' ? 'Yes' : 'No') + ')';
                }
            }
            document.getElementById('result_scai_mortality').textContent = scaiMortality || 'Not calculated';
            document.getElementById('result_cardshock').textContent = cardshockScore + ' / 9';
            document.getElementById('result_cardshock_mort').textContent = cardshockMortality;
            document.getElementById('result_save').textContent = saveComplete ? saveScore : 'INCOMPLETE';
            document.getElementById('result_save_class').textContent = saveComplete ? `Class ${saveClass}` : 'INCOMPLETE';
            document.getElementById('result_save_survival').textContent = saveComplete ? saveSurvival : 'INCOMPLETE';
            
            // Update clinical decision framework
            const scaiETotalDisplay = scaiETotal > 0 ? `${scaiETotal} / 6${patientAge > 0 ? ' (Age: ' + patientAge + ')' : ''}` : 'Not calculated';
            document.getElementById('decision_scai_e_total').textContent = scaiETotalDisplay;
            document.getElementById('decision_without_ecmo').textContent = deathWithoutECMO;
            document.getElementById('decision_with_ecmo').textContent = deathWithECMO;
            document.getElementById('decision_benefit').textContent = benefit;
            document.getElementById('decision_complications').textContent = complications;
            
            // Update final recommendation
            const finalRecEl = document.getElementById('final_recommendation');
            finalRecEl.textContent = finalRec;
            
            if (recClass === 'danger') {
                finalRecEl.style.background = 'linear-gradient(135deg, #dc2626 0%, #991b1b 100%)';
            } else if (recClass === 'success') {
                finalRecEl.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else if (recClass === 'info') {
                finalRecEl.style.background = 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)';
            } else {
                finalRecEl.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            }
            
            // Show results section
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Generate summary text
        function generateSummary() {
            const patientName = document.getElementById('patientName').value || 'Unknown';
            const age = document.getElementById('age').value || 'Unknown';
            const weight = document.getElementById('weight').value || 'Unknown';
            const height = document.getElementById('height').value || 'Unknown';
            const bmi = document.getElementById('bmi').value || 'Unknown';
            const hospital = document.getElementById('hospital').options[document.getElementById('hospital').selectedIndex]?.text || 'Unknown';
            const assessmentDate = document.getElementById('assessmentDate').value || new Date().toISOString().slice(0,16);
            
            const scaiStage = document.getElementById('scai').value || 'Not selected';
            const cardshockScore = document.getElementById('result_cardshock').textContent;
            const cardshockMort = document.getElementById('result_cardshock_mort').textContent;
            const saveScore = document.getElementById('result_save').textContent;
            const saveClass = document.getElementById('result_save_class').textContent;
            const saveSurvival = document.getElementById('result_save_survival').textContent;
            
            const deathWithout = document.getElementById('decision_without_ecmo').textContent;
            const deathWith = document.getElementById('decision_with_ecmo').textContent;
            const benefit = document.getElementById('decision_benefit').textContent;
            const complications = document.getElementById('decision_complications').textContent;
            
            const recommendation = document.getElementById('final_recommendation').textContent;
            
            const clinicalNotes = document.getElementById('clinical_notes').value || 'None recorded';
            const mdtNotes = document.getElementById('mdt_notes').value || 'None recorded';
            const familyNotes = document.getElementById('family_notes').value || 'None recorded';
            const assessor = document.getElementById('assessor').value || 'Not specified';
            
            const summary = `
VA-ECMO REFERRAL ASSESSMENT SUMMARY
Bristol ECMO Service
=====================================

PATIENT DETAILS
Patient ID: ${patientName}
Age: ${age} years
Weight: ${weight} kg
Height: ${height} cm
BMI: ${bmi} kg/m²
Referring Hospital: ${hospital}
Assessment Date: ${assessmentDate}

RISK SCORES
-----------
SCAI Shock Stage: ${scaiStage}
CardShock Score: ${cardshockScore}
CardShock Mortality: ${cardshockMort}
SAVE Score: ${saveScore}
SAVE Risk Class: ${saveClass}
Predicted Survival: ${saveSurvival}

CLINICAL DECISION FRAMEWORK
---------------------------
Risk of death WITHOUT ECMO: ${deathWithout}
Risk of death WITH ECMO: ${deathWith}
Expected benefit from ECMO: ${benefit}
ECMO complications risk: ${complications}

RECOMMENDATION
--------------
${recommendation}

CLINICAL NOTES
--------------
${clinicalNotes}

MDT DISCUSSION
--------------
${mdtNotes}

FAMILY DISCUSSION
-----------------
${familyNotes}

Assessed by: ${assessor}
Generated: ${new Date().toLocaleString('en-GB')}

=====================================
Bristol ECMO Service - VA-ECMO Assessment Tool v2.1
This is an automated summary. Clinical judgement essential.
`;
            
            return summary;
        }
        
        // Print as PDF
        function printPDF() {
            window.print();
        }
        
        // Download as plain text
        function printPlainText() {
            const summary = generateSummary();
            const blob = new Blob([summary], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `VAECMO_Assessment_${document.getElementById('patientName').value || 'Patient'}_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Colour coding functions for Step 3 respiratory parameters
        function highlightFiO2(input) {
            const value = parseFloat(input.value);
            input.style.backgroundColor = '';
            if (value >= 0.6) {
                input.style.backgroundColor = '#ff6b6b'; // Red for FiO2 >= 0.6
            } else if (value >= 0.4 && value < 0.6) {
                input.style.backgroundColor = '#ffd93d'; // Amber for 0.4-0.6
            } else if (value < 0.4) {
                input.style.backgroundColor = '#51cf66'; // Green for < 0.4
            }
        }
        
        function highlightPEEP(input) {
            const value = parseFloat(input.value);
            input.style.backgroundColor = '';
            if (value < 6) {
                input.style.backgroundColor = '#51cf66'; // Green if < 6 cmH2O
            } else if (value >= 6 && value < 8) {
                input.style.backgroundColor = '#ffd93d'; // Amber if 6-8
            } else if (value >= 8) {
                input.style.backgroundColor = '#ff6b6b'; // Red if >= 8
            }
            calculateDrivingPressure();
        }
        
        function highlightPlateauPressure(input) {
            const value = parseFloat(input.value);
            input.style.backgroundColor = '';
            // Colour coding based on plateau pressure ranges
            if (value <= 30) {
                input.style.backgroundColor = '#51cf66'; // Green <= 30 cmH2O
            } else if (value > 30 && value <= 35) {
                input.style.backgroundColor = '#ffd93d'; // Amber 30-35
            } else if (value > 35) {
                input.style.backgroundColor = '#ff6b6b'; // Red > 35
            }
            calculateDrivingPressure();
        }
        
        function highlightDrivingPressure(input) {
            const value = parseFloat(input.value);
            input.style.backgroundColor = '';
            if (value < 15) {
                input.style.backgroundColor = '#51cf66'; // Green < 15 cmH2O
            } else if (value >= 15 && value <= 18) {
                input.style.backgroundColor = '#ffd93d'; // Amber 15-18
            } else if (value > 18) {
                input.style.backgroundColor = '#ff6b6b'; // Red > 18
            }
        }
        
        function calculateDrivingPressure() {
            const plateauPressure = parseFloat(document.getElementById('plat_pressure').value) || 0;
            const peep = parseFloat(document.getElementById('peep').value) || 0;
            const drivingPressure = plateauPressure - peep;
            
            if (plateauPressure > 0 && peep >= 0) {
                const dpField = document.getElementById('driving_pressure');
                dpField.value = drivingPressure.toFixed(1);
                highlightDrivingPressure(dpField);
            }
        }
        
        // Calculate Tidal Volume per kg
        function calculateTidalVolumePerKg() {
            const tidalVolume = parseFloat(document.getElementById('tidal_volume').value) || 0;
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            
            if (tidalVolume > 0 && weight > 0) {
                const tvPerKg = tidalVolume / weight;
                document.getElementById('tidal_vol_per_kg').value = tvPerKg.toFixed(1);
            }
        }
        
        // eGFR calculation using CKD-EPI formula
        function calculateEGFR() {
            const creatinine = parseFloat(document.getElementById('creatinine').value);
            const age = parseInt(document.getElementById('age').value);
            const sex = document.getElementById('sex').value;
            
            if (!creatinine || !age || !sex) {
                return;
            }
            
            // Convert creatinine from µmol/L to mg/dL
            const creatMgDl = creatinine / 88.4;
            
            // CKD-EPI formula
            let kappa, alpha;
            if (sex === 'female') {
                kappa = 0.7;
                alpha = -0.329;
            } else {
                kappa = 0.9;
                alpha = -0.411;
            }
            
            const minTerm = Math.min(creatMgDl / kappa, 1);
            const maxTerm = Math.max(creatMgDl / kappa, 1);
            
            let egfr = 141 * Math.pow(minTerm, alpha) * Math.pow(maxTerm, -1.209) * Math.pow(0.993, age);
            
            if (sex === 'female') {
                egfr *= 1.018;
            }
            
            document.getElementById('egfr').value = Math.round(egfr);
        }
        
        // Master update function for calculations table
        function updateCalculations() {
            updateTidalVolumePerKg();
            updateDrivingPressure();
            updatePFRatio();
            updateMechanicalPower();
        }
        
        // Tidal Volume per kg calculation
        function updateTidalVolumePerKg() {
            const tidalVolume = parseFloat(document.getElementById('tidal_volume').value) || 0;
            const ibw = parseFloat(document.getElementById('ibw').value) || 0;
            
            const cell = document.getElementById('calc_tv_kg');
            const statusCell = document.getElementById('calc_tv_kg_status');
            const row = document.getElementById('calc_row_tv_kg');
            
            if (tidalVolume > 0 && ibw > 0) {
                const tvPerKg = tidalVolume / ibw;
                cell.textContent = tvPerKg.toFixed(1) + ' ml/kg';
                
                // Colour coding based on lung-protective ventilation
                row.className = '';
                if (tvPerKg < 6) {
                    statusCell.textContent = 'Low - consider adequacy';
                    row.classList.add('calc-amber');
                } else if (tvPerKg >= 6 && tvPerKg <= 8) {
                    statusCell.textContent = 'Protective range';
                    row.classList.add('calc-green');
                } else if (tvPerKg > 8 && tvPerKg <= 10) {
                    statusCell.textContent = 'Elevated';
                    row.classList.add('calc-amber');
                } else {
                    statusCell.textContent = 'High - risk of VILI';
                    row.classList.add('calc-red');
                }
            } else {
                cell.textContent = '-';
                statusCell.textContent = '-';
                row.className = '';
            }
        }
        
        // Driving Pressure calculation
        function updateDrivingPressure() {
            const plateauPressure = parseFloat(document.getElementById('plat_pressure').value) || 0;
            const peep = parseFloat(document.getElementById('peep').value) || 0;
            
            const cell = document.getElementById('calc_driving_pressure');
            const statusCell = document.getElementById('calc_driving_pressure_status');
            const row = document.getElementById('calc_row_driving_pressure');
            
            if (plateauPressure > 0 && peep >= 0) {
                const drivingPressure = plateauPressure - peep;
                cell.textContent = drivingPressure.toFixed(1) + ' cmH₂O';
                
                // Colour coding
                row.className = '';
                if (drivingPressure < 15) {
                    statusCell.textContent = 'Protective';
                    row.classList.add('calc-green');
                } else if (drivingPressure >= 15 && drivingPressure <= 18) {
                    statusCell.textContent = 'Moderate risk';
                    row.classList.add('calc-amber');
                } else {
                    statusCell.textContent = 'High risk - consider ECMO';
                    row.classList.add('calc-red');
                }
            } else {
                cell.textContent = '-';
                statusCell.textContent = '-';
                row.className = '';
            }
        }
        
        // P/F Ratio calculation
        function updatePFRatio() {
            const pao2_kpa = parseFloat(document.getElementById('abg_pao2').value) || 0;
            const fio2 = parseFloat(document.getElementById('fio2_current').value) || 0;
            
            const cell = document.getElementById('calc_pf_ratio');
            const statusCell = document.getElementById('calc_pf_ratio_status');
            const row = document.getElementById('calc_row_pf_ratio');
            
            if (pao2_kpa > 0 && fio2 > 0) {
                // Convert PaO2 from kPa to mmHg (multiply by 7.5)
                const pao2_mmhg = pao2_kpa * 7.5;
                const pfRatio = pao2_mmhg / fio2;
                
                cell.textContent = pfRatio.toFixed(0);
                
                // Colour coding
                row.className = '';
                if (pfRatio >= 300) {
                    statusCell.textContent = 'Normal';
                    row.classList.add('calc-green');
                } else if (pfRatio >= 200 && pfRatio < 300) {
                    statusCell.textContent = 'Mild ARDS';
                    row.classList.add('calc-amber');
                } else if (pfRatio >= 100 && pfRatio < 200) {
                    statusCell.textContent = 'Moderate ARDS';
                    row.classList.add('calc-amber');
                } else if (pfRatio < 100) {
                    statusCell.textContent = 'Severe ARDS';
                    row.classList.add('calc-red');
                }
            } else {
                cell.textContent = '-';
                statusCell.textContent = '-';
                row.className = '';
            }
            
            updateARDSSeverity();
        }
        
        // ARDS Severity assessment
        function updateARDSSeverity() {
            const pao2_kpa = parseFloat(document.getElementById('abg_pao2').value) || 0;
            const fio2 = parseFloat(document.getElementById('fio2_current').value) || 0;
            const peep = parseFloat(document.getElementById('peep').value) || 0;
            
            const cell = document.getElementById('calc_ards_severity');
            const statusCell = document.getElementById('calc_ards_severity_status');
            const row = document.getElementById('calc_row_ards_severity');
            
            if (pao2_kpa > 0 && fio2 > 0) {
                const pao2_mmhg = pao2_kpa * 7.5;
                const pfRatio = pao2_mmhg / fio2;
                
                row.className = '';
                
                // Berlin Criteria requires PEEP ≥5 for classification
                if (peep < 5) {
                    cell.textContent = 'PEEP <5 (Berlin criteria not met)';
                    statusCell.textContent = 'Increase PEEP to ≥5';
                    row.classList.add('calc-amber');
                } else if (pfRatio >= 200 && pfRatio <= 300) {
                    cell.textContent = 'Mild ARDS';
                    statusCell.textContent = 'P/F 200-300, PEEP ≥5';
                    row.classList.add('calc-amber');
                } else if (pfRatio >= 100 && pfRatio < 200) {
                    cell.textContent = 'Moderate ARDS';
                    statusCell.textContent = 'P/F 100-200, PEEP ≥5';
                    row.classList.add('calc-amber');
                } else if (pfRatio < 100) {
                    cell.textContent = 'Severe ARDS';
                    statusCell.textContent = 'P/F <100, consider ECMO';
                    row.classList.add('calc-red');
                } else {
                    cell.textContent = 'No ARDS';
                    statusCell.textContent = 'P/F >300';
                    row.classList.add('calc-green');
                }
            } else {
                cell.textContent = '-';
                statusCell.textContent = '-';
                row.className = '';
            }
        }
        
        // Mechanical Power calculation
        function updateMechanicalPower() {
            const respRate = parseFloat(document.getElementById('resp_rate').value) || 0;
            const tidalVolume = parseFloat(document.getElementById('tidal_volume').value) || 0;
            const peep = parseFloat(document.getElementById('peep').value) || 0;
            const plateauPressure = parseFloat(document.getElementById('plat_pressure').value) || 0;
            const pip = parseFloat(document.getElementById('pip').value) || 0;
            
            const cell = document.getElementById('calc_mech_power');
            const statusCell = document.getElementById('calc_mech_power_status');
            const row = document.getElementById('calc_row_mech_power');
            
            // Simplified mechanical power formula: 0.098 * RR * VT * (Pplat - PEEP/2)
            // VT in litres, pressures in cmH2O
            if (respRate > 0 && tidalVolume > 0 && plateauPressure > 0 && peep >= 0) {
                const vt_L = tidalVolume / 1000;
                const drivingPressure = plateauPressure - peep;
                const mechPower = 0.098 * respRate * vt_L * (peep + drivingPressure / 2);
                
                cell.textContent = mechPower.toFixed(1) + ' J/min';
                
                // Colour coding
                row.className = '';
                if (mechPower < 12) {
                    statusCell.textContent = 'Low risk';
                    row.classList.add('calc-green');
                } else if (mechPower >= 12 && mechPower < 17) {
                    statusCell.textContent = 'Moderate risk';
                    row.classList.add('calc-amber');
                } else {
                    statusCell.textContent = 'High risk of VILI';
                    row.classList.add('calc-red');
                }
            } else {
                cell.textContent = '-';
                statusCell.textContent = '-';
                row.className = '';
            }
        }
        
        // Add event listeners for weight and tidal volume changes
        document.addEventListener('DOMContentLoaded', function() {
            const weightInput = document.getElementById('weight');
            const tidalVolumeInput = document.getElementById('tidal_volume');
            const ageInput = document.getElementById('age');
            const sexInput = document.getElementById('sex');
            const creatinineInput = document.getElementById('creatinine');
            
            if (weightInput) weightInput.addEventListener('input', updateCalculations);
            if (tidalVolumeInput) tidalVolumeInput.addEventListener('input', updateCalculations);
            if (ageInput) ageInput.addEventListener('change', calculateEGFR);
            if (sexInput) sexInput.addEventListener('change', calculateEGFR);
            if (creatinineInput) creatinineInput.addEventListener('input', calculateEGFR);
        });
        
        // Synchronize Current Support fields between Step 4 and Step 8
        function syncSupportFields(source) {
            if (source === 'step4') {
                // Sync from Step 4 to Step 8
                const support = document.getElementById('scai_support_step4').value;
                const mcs = document.getElementById('scai_mcs_step4').value;
                const response = document.getElementById('scai_response_step4').value;
                
                document.getElementById('scai_support').value = support;
                document.getElementById('scai_mcs').value = mcs;
                document.getElementById('scai_response').value = response;
                
                // Trigger SCAI auto-calculation
                if (typeof autoCalculateSCAI === 'function') {
                    autoCalculateSCAI();
                }
            } else if (source === 'step8') {
                // Sync from Step 8 to Step 4
                const support = document.getElementById('scai_support').value;
                const mcs = document.getElementById('scai_mcs').value;
                const response = document.getElementById('scai_response').value;
                
                document.getElementById('scai_support_step4').value = support;
                document.getElementById('scai_mcs_step4').value = mcs;
                document.getElementById('scai_response_step4').value = response;
            }
        }
        
        // Synchronize Physical Examination fields between Step 4 and Step 8
        function syncPhysicalExam(source) {
            if (source === 'step4') {
                // Sync from Step 4 to Step 8
                const bp = document.getElementById('scai_bp_step4').value;
                const perfusion = document.getElementById('scai_perfusion_step4').value;
                const volume = document.getElementById('scai_volume_step4').value;
                
                document.getElementById('scai_bp').value = bp;
                document.getElementById('scai_perfusion').value = perfusion;
                document.getElementById('scai_volume').value = volume;
                
                // Trigger SCAI auto-calculation
                if (typeof autoCalculateSCAI === 'function') {
                    autoCalculateSCAI();
                }
            } else if (source === 'step8') {
                // Sync from Step 8 to Step 4
                const bp = document.getElementById('scai_bp').value;
                const perfusion = document.getElementById('scai_perfusion').value;
                const volume = document.getElementById('scai_volume').value;
                
                document.getElementById('scai_bp_step4').value = bp;
                document.getElementById('scai_perfusion_step4').value = perfusion;
                document.getElementById('scai_volume_step4').value = volume;
            }
        }
        
        // Synchronize Biochemical Markers (pH and Lactate) between Step 4 and Step 8
        function syncBiochemicalMarkers(source) {
            if (source === 'step4') {
                // Sync from Step 4 ABG to Step 8 Biochemical Markers
                const ph = document.getElementById('abg_ph').value;
                const lactate = document.getElementById('lactate').value;
                
                document.getElementById('scai_ph').value = ph;
                document.getElementById('scai_lactate').value = lactate;
                
                // Trigger SCAI auto-calculation
                if (typeof autoCalculateSCAI === 'function') {
                    autoCalculateSCAI();
                }
            } else if (source === 'step8') {
                // Sync from Step 8 to Step 4 ABG
                const ph = document.getElementById('scai_ph').value;
                const lactate = document.getElementById('scai_lactate').value;
                
                document.getElementById('abg_ph').value = ph;
                document.getElementById('lactate').value = lactate;
            }
        }
        
        // Set current date/time on load
        document.addEventListener('DOMContentLoaded', function() {
            const now = new Date();
            const datetime = now.toISOString().slice(0, 16);
            document.getElementById('assessmentDate').value = datetime;
        });
    </script>
</body>
</html>
